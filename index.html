<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <title>PARADISE ZENITH</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* --- THEME CONFIG --- */
            --bg-app: #000000;
            --bg-card: #1c1c1e;
            --bg-glass: rgba(28, 28, 30, 0.7);
            --primary: #0A84FF;
            --accent: #BF5AF2;
            --text-main: #FFFFFF;
            --text-sec: #8E8E93;
            --separator: rgba(84, 84, 88, 0.65);
            --danger: #FF453A;
            --success: #30D158;
            
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: 'SF Pro Display', sans-serif; }
        
        body {
            background-color: var(--bg-app);
            color: var(--text-main);
            height: 100vh; width: 100vw; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- HEADER --- */
        .header {
            padding: calc(var(--safe-top) + 10px) 16px 12px;
            background: var(--bg-glass); backdrop-filter: blur(20px);
            border-bottom: 0.5px solid var(--separator);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 50;
        }
        .brand { font-size: 20px; font-weight: 800; letter-spacing: 0.5px; background: linear-gradient(90deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .settings-btn { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--primary); transition: 0.2s; }
        .settings-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }

        /* --- CONTENT --- */
        .content {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding: 16px; padding-bottom: calc(100px + var(--safe-bottom));
            -webkit-overflow-scrolling: touch;
        }

        /* --- LINKS --- */
        .links-row { display: flex; gap: 10px; margin-bottom: 20px; }
        .link-card {
            flex: 1; background: var(--bg-card); padding: 12px; border-radius: 14px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            text-decoration: none; color: var(--text-main); font-weight: 600; font-size: 13px;
            transition: 0.2s;
        }
        .link-card:active { opacity: 0.7; transform: scale(0.98); }
        .link-card i { color: var(--accent); font-size: 16px; }

        /* --- GRID --- */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card {
            background: var(--bg-card); border-radius: 16px; overflow: hidden;
            position: relative; transition: transform 0.1s;
            animation: fadeIn 0.4s ease;
        }
        .card:active { transform: scale(0.97); }
        
        .card-img-wrap {
            width: 100%; padding-top: 100%; position: relative; background: #2c2c2e;
        }
        .card-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .no-img { position: absolute; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; color: var(--text-sec); font-size: 30px; }

        .card-info { padding: 10px 12px 14px; }
        .card-name { font-size: 15px; font-weight: 600; margin-bottom: 4px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .card-price { font-size: 16px; font-weight: 700; color: var(--primary); }

        /* --- BOTTOM SHEET --- */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .overlay.active { opacity: 1; pointer-events: auto; }

        .sheet {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #1c1c1e; border-radius: 24px 24px 0 0;
            padding: 24px 20px calc(20px + var(--safe-bottom));
            transform: translateY(100%); transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 101; border-top: 0.5px solid var(--separator);
        }
        .sheet.active { transform: translateY(0); }

        .sheet-head { display: flex; gap: 16px; margin-bottom: 24px; }
        .sheet-cover { width: 80px; height: 80px; border-radius: 16px; object-fit: cover; background: #2c2c2e; }
        
        .chips { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; }
        .chip {
            padding: 8px 16px; background: #2c2c2e; border-radius: 20px;
            font-size: 14px; font-weight: 500; white-space: nowrap; transition: 0.2s;
        }
        .chip.selected { background: var(--text-main); color: #000; font-weight: 700; }

        .promo-block {
            background: #2c2c2e; border-radius: 12px; padding: 4px; display: flex; margin-bottom: 24px;
        }
        .promo-inp { flex: 1; background: transparent; border: none; padding: 0 12px; color: white; font-size: 15px; outline: none; }
        .promo-btn { background: #3a3a3c; color: white; border: none; padding: 10px 16px; border-radius: 10px; font-weight: 600; font-size: 13px; transition: 0.2s; }
        .promo-btn:active { background: var(--success); }

        .actions { display: flex; gap: 12px; align-items: center; }
        .counter { display: flex; align-items: center; background: #2c2c2e; border-radius: 14px; padding: 4px; }
        .c-btn { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: var(--primary); }
        .c-val { width: 40px; text-align: center; font-size: 18px; font-weight: 600; }

        .buy-btn {
            flex: 1; height: 52px; background: var(--primary); border-radius: 14px;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
            color: white; font-size: 17px; font-weight: 700; box-shadow: 0 4px 20px rgba(10, 132, 255, 0.4);
            transition: 0.2s;
        }
        .buy-btn:active { transform: scale(0.97); }

        /* --- ADMIN SCREEN (FULL) --- */
        .screen {
            position: fixed; inset: 0; background: #000; z-index: 200;
            display: flex; flex-direction: column; transform: translateX(100%);
            transition: 0.3s cubic-bezier(0.2, 0.9, 0.3, 1);
        }
        .screen.visible { transform: translateX(0); }

        .screen-nav {
            padding: calc(var(--safe-top) + 10px) 16px 12px;
            background: #1c1c1e; border-bottom: 0.5px solid var(--separator);
            display: flex; justify-content: space-between; align-items: center;
        }
        .nav-title { font-size: 17px; font-weight: 700; }
        .nav-close { color: var(--primary); font-size: 17px; font-weight: 400; }

        .screen-body { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: calc(50px + var(--safe-bottom)); }

        .form-group { background: #1c1c1e; border-radius: 12px; padding: 0 16px; margin-bottom: 24px; }
        .f-row { border-bottom: 0.5px solid var(--separator); padding: 12px 0; display: flex; align-items: center; }
        .f-row:last-child { border-bottom: none; }
        
        .f-input { width: 100%; background: transparent; border: none; color: white; font-size: 17px; outline: none; padding: 4px 0; }
        .f-input::placeholder { color: #555; }

        .upload-btn { color: var(--primary); font-size: 17px; display: flex; align-items: center; gap: 10px; width: 100%; }
        
        .list-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 0;
            border-bottom: 0.5px solid var(--separator);
        }
        .li-img { width: 48px; height: 48px; border-radius: 8px; background: #2c2c2e; object-fit: cover; }
        .li-info { flex: 1; }
        .li-title { font-size: 16px; font-weight: 600; margin-bottom: 2px; }
        .li-sub { font-size: 13px; color: var(--text-sec); }
        .li-del { color: var(--danger); font-size: 14px; font-weight: 600; padding: 8px; }

        /* AUTH */
        .auth-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 500; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .pass-dots { display: flex; gap: 16px; margin-top: 30px; }
        .dot { width: 14px; height: 14px; border-radius: 50%; border: 1px solid #555; transition: 0.2s; }
        .dot.filled { background: white; border-color: white; }
        
        /* UTILS */
        .loader { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; align-items: center; justify-content: center; transition: 0.5s; }
        
        .toast {
            position: fixed; top: calc(var(--safe-top) + 10px); left: 50%; transform: translateX(-50%) translateY(-100px);
            background: rgba(50, 50, 50, 0.9); backdrop-filter: blur(10px);
            padding: 12px 24px; border-radius: 30px; font-weight: 600; font-size: 14px;
            z-index: 2000; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; gap: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        @keyframes fadeIn { from{opacity:0}to{opacity:1} }
    </style>
</head>
<body>

    <div class="header">
        <div class="brand">Paradise</div>
        <div class="settings-btn" onclick="openAuth()"><i class="fas fa-sliders-h"></i></div>
    </div>

    <div class="content">
        <div class="links-row">
            <a href="https://t.me/sparadiseinfo" class="link-card">
                <i class="fas fa-info-circle"></i> Info
            </a>
            <a href="https://t.me/+N8WkPq6XQ6I5MjJk" class="link-card">
                <i class="fas fa-paper-plane"></i> Channel
            </a>
        </div>

        <div class="grid" id="grid"></div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="sheet" id="sheet">
        <div class="sheet-head">
            <img src="" class="sheet-cover" id="sImg">
            <div>
                <div style="font-size: 20px; font-weight: 700; line-height: 1.2; margin-bottom: 4px;" id="sTitle">Product</div>
                <div style="font-size: 13px; color: var(--text-sec); max-height: 40px; overflow: hidden;" id="sDesc">Desc</div>
            </div>
        </div>

        <div style="font-size:12px; color:var(--text-sec); font-weight:600; text-transform:uppercase; margin-bottom:10px;">–í–∫—É—Å—ã</div>
        <div class="chips" id="sFlavors"></div>

        <div class="promo-block">
            <input type="text" class="promo-inp" id="promoInput" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥">
            <button class="promo-btn" onclick="checkPromo()">OK</button>
        </div>

        <div class="actions">
            <div class="counter">
                <div class="c-btn" onclick="updQty(-1)">-</div>
                <div class="c-val" id="sQty">1</div>
                <div class="c-btn" onclick="updQty(1)">+</div>
            </div>
            <div class="buy-btn" id="orderBtn">
                <span>–ö—É–ø–∏—Ç—å</span>
                <span id="sTotal">0 ‚Ç¨</span>
            </div>
        </div>
    </div>

    <div class="screen" id="adminScreen">
        <div class="screen-nav">
            <div class="nav-title">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>
            <div class="nav-close" onclick="closeAdmin()">–ì–æ—Ç–æ–≤–æ</div>
        </div>
        <div class="screen-body">
            
            <div style="font-size:13px; color:var(--text-sec); text-transform:uppercase; margin-bottom:10px; margin-left:16px;">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</div>
            <div class="form-group">
                <div class="f-row" onclick="document.getElementById('fileIn').click()">
                    <div class="upload-btn">
                        <i class="fas fa-camera"></i> <span>–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</span>
                        <img id="previewImg" style="width:30px; height:30px; border-radius:6px; object-fit:cover; margin-left:auto; display:none;">
                    </div>
                    <input type="file" id="fileIn" hidden accept="image/*">
                </div>
                <div class="f-row"><input id="inpName" class="f-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"></div>
                <div class="f-row"><input id="inpPrice" type="number" class="f-input" placeholder="–¶–µ–Ω–∞ (‚Ç¨)"></div>
                <div class="f-row"><input id="inpFlavors" class="f-input" placeholder="–í–∫—É—Å—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)"></div>
                <div class="f-row"><input id="inpDesc" class="f-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></div>
            </div>
            <div class="buy-btn" style="justify-content:center; margin-bottom:30px;" onclick="saveProduct()">–î–æ–±–∞–≤–∏—Ç—å –≤ –±–∞–∑—É</div>

            <div style="font-size:13px; color:var(--text-sec); text-transform:uppercase; margin-bottom:10px; margin-left:16px;">–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</div>
            <div class="form-group" id="goodsList" style="padding: 0 16px;"></div>

            <div style="font-size:13px; color:var(--text-sec); text-transform:uppercase; margin-bottom:10px; margin-left:16px;">–ü—Ä–æ–º–æ–∫–æ–¥—ã</div>
            <div class="form-group">
                <div class="f-row"><input id="pmCode" class="f-input" placeholder="–ö–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä SALE)" style="text-transform:uppercase"></div>
                <div class="f-row"><input id="pmDisc" type="number" class="f-input" placeholder="–°–∫–∏–¥–∫–∞ (%)"></div>
                <div class="f-row" onclick="savePromo()" style="color:var(--success); font-weight:600; justify-content:center;">–°–æ–∑–¥–∞—Ç—å –∫–æ–¥</div>
            </div>
            <div class="form-group" id="promoList" style="padding: 0 16px;"></div>

        </div>
    </div>

    <div class="auth-overlay" id="authOverlay">
        <div style="display:flex; flex-direction:column; align-items:center;">
            <i class="fas fa-lock" style="font-size:32px; color:white; margin-bottom:20px;"></i>
            <div style="color:white; font-size:20px; font-weight:600;">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</div>
            <div class="pass-dots">
                <div class="dot" id="d1"></div><div class="dot" id="d2"></div>
                <div class="dot" id="d3"></div><div class="dot" id="d4"></div>
            </div>
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:24px; margin-top:40px;">
                <div class="n-btn" onclick="tap(1)">1</div><div class="n-btn" onclick="tap(2)">2</div><div class="n-btn" onclick="tap(3)">3</div>
                <div class="n-btn" onclick="tap(4)">4</div><div class="n-btn" onclick="tap(5)">5</div><div class="n-btn" onclick="tap(6)">6</div>
                <div class="n-btn" onclick="tap(7)">7</div><div class="n-btn" onclick="tap(8)">8</div><div class="n-btn" onclick="tap(9)">9</div>
                <div class="n-btn" onclick="closeAuth()" style="font-size:16px;">‚úï</div>
                <div class="n-btn" onclick="tap(0)">0</div>
                <div class="n-btn" onclick="del()"><i class="fas fa-backspace"></i></div>
            </div>
        </div>
    </div>
    <style>.n-btn { width: 64px; height: 64px; border-radius: 50%; background: rgba(255,255,255,0.1); color: white; font-size: 26px; display: flex; align-items: center; justify-content: center; transition: 0.2s; } .n-btn:active { background: rgba(255,255,255,0.3); }</style>

    <div id="loader" class="loader"><i class="fas fa-spinner fa-spin fa-2x" style="color:var(--primary)"></i></div>
    <div id="toast" class="toast"></div>

    <script>
        // === CONFIG ===
        const BIN_ID = "696ea19bd0ea881f4076e7ce";
        const API_KEY = "$2a$10$L2N3z0hcYt/KjMIcI402euuF0nMvX.RMLI8RCugRIyy6/NX7K3QXy";
        const ADMIN_PIN = "1234"; // –ü–∏–Ω-–∫–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
        const TG_USER = "Lacky337"; 

        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();
        tg.setHeaderColor('#1c1c1e'); 
        tg.setBackgroundColor('#000000');

        let db = { products: [], promos: [] };
        let curItem = null, curQty = 1, curFlavor = '', activePromo = null;
        let pin = "";

        // --- INIT ---
        window.onload = async () => {
            await loadData();
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').style.display='none', 500);
        };

        async function loadData() {
            try {
                const r = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { 'X-Master-Key': API_KEY } });
                if(r.ok) {
                    const d = await r.json();
                    db = Array.isArray(d.record) ? { products: d.record, promos: [] } : d.record;
                    if(!db.products) db.products = [];
                    if(!db.promos) db.promos = [];
                }
                renderGrid();
                renderAdmin();
            } catch(e) { toast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", true); }
        }

        async function sync() {
            toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...");
            await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                body: JSON.stringify(db)
            });
            toast("–ì–æ—Ç–æ–≤–æ!");
        }

        // --- SHOP ---
        function renderGrid() {
            const g = document.getElementById('grid');
            g.innerHTML = '';
            if(!db.products.length) g.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#555;">–ü—É—Å—Ç–æ</div>';
            
            db.products.forEach(p => {
                const el = document.createElement('div');
                el.className = 'card';
                let im = p.image ? `<img src="${p.image}" class="card-img">` : `<div class="no-img"><i class="fas fa-box"></i></div>`;
                el.innerHTML = `<div class="card-img-wrap">${im}</div><div class="card-info"><div class="card-name">${p.name}</div><div class="card-price">${p.price} ‚Ç¨</div></div>`;
                el.onclick = () => openSheet(p);
                g.appendChild(el);
            });
        }

        function openSheet(p) {
            curItem = p; curQty = 1; activePromo = null;
            document.getElementById('sImg').src = p.image || '';
            document.getElementById('sTitle').innerText = p.name;
            document.getElementById('sDesc').innerText = p.desc || '';
            document.getElementById('promoInput').value = '';
            
            const c = document.getElementById('sFlavors');
            c.innerHTML = '';
            if(p.flavors && p.flavors.length) {
                curFlavor = p.flavors[0];
                p.flavors.forEach(f => {
                    const el = document.createElement('div');
                    el.className = `chip ${f===curFlavor?'selected':''}`;
                    el.innerText = f;
                    el.onclick = () => {
                        curFlavor = f;
                        document.querySelectorAll('.chip').forEach(x=>x.classList.remove('selected'));
                        el.classList.add('selected');
                        tg.HapticFeedback.selectionChanged();
                    }
                    c.appendChild(el);
                });
            } else {
                curFlavor = "–°—Ç–∞–Ω–¥–∞—Ä—Ç";
                c.innerHTML = '<span style="color:#555; font-size:13px;">–ë–µ–∑ –≤—ã–±–æ—Ä–∞</span>';
            }
            
            calc();
            document.getElementById('overlay').classList.add('active');
            document.getElementById('sheet').classList.add('active');
            tg.HapticFeedback.impactOccurred('medium');
        }

        function updQty(v) {
            if(curQty+v < 1) return;
            curQty += v;
            document.getElementById('sQty').innerText = curQty;
            calc();
            tg.HapticFeedback.selectionChanged();
        }

        function checkPromo() {
            const code = document.getElementById('promoInput').value.trim().toUpperCase();
            const f = db.promos.find(x => x.code === code);
            if(f) {
                activePromo = f;
                toast(`–°–∫–∏–¥–∫–∞ -${f.disc}%`);
                tg.HapticFeedback.notificationOccurred('success');
                calc();
            } else {
                toast("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥", true);
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        function calc() {
            let p = parseFloat(curItem.price) * curQty;
            if(activePromo) p = p * (1 - activePromo.disc/100);
            document.getElementById('sTotal').innerText = p.toFixed(2) + ' ‚Ç¨';
        }

        // --- ORDER (FIXED & TESTED) ---
        document.getElementById('orderBtn').onclick = () => {
            let sum = parseFloat(curItem.price) * curQty;
            let final = sum;
            let pTxt = "";
            
            if(activePromo) {
                final = sum * (1 - activePromo.disc/100);
                pTxt = `üéü –ü—Ä–æ–º–æ: ${activePromo.code} (-${activePromo.disc}%)\n`;
            }

            const msg = `‚ö°Ô∏è *–ó–ê–ö–ê–ó PARADISE*\n\n` +
                        `üì¶ *${curItem.name}*\n` +
                        `üîπ ${curFlavor}\n` +
                        `üî¢ –ö–æ–ª-–≤–æ: ${curQty}\n` +
                        `${pTxt}` +
                        `üí∞ *–°—É–º–º–∞: ${final.toFixed(2)} ‚Ç¨*`;

            const url = `https://t.me/${TG_USER}?text=${encodeURIComponent(msg)}`;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ Telegram –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è
            try {
                tg.openTelegramLink(url);
            } catch(e) {
                window.open(url, '_blank');
            }
            tg.close();
        };

        // --- ADMIN ---
        function openAuth() { pin = ""; updDots(); document.getElementById('authOverlay').style.display='flex'; }
        function closeAuth() { document.getElementById('authOverlay').style.display='none'; }
        
        function tap(n) {
            if(pin.length < 4) {
                pin += n; updDots();
                if(pin.length === 4) {
                    if(pin === ADMIN_PIN) {
                        closeAuth();
                        document.getElementById('adminScreen').classList.add('visible');
                        renderAdmin();
                    } else {
                        pin = ""; updDots();
                        tg.HapticFeedback.notificationOccurred('error');
                    }
                }
            }
        }
        function del() { pin = pin.slice(0,-1); updDots(); }
        function updDots() {
            for(let i=1; i<=4; i++) {
                document.getElementById('d'+i).className = i <= pin.length ? 'dot filled' : 'dot';
            }
        }
        function closeAdmin() { document.getElementById('adminScreen').classList.remove('visible'); }

        async function saveProduct() {
            const n = document.getElementById('inpName').value;
            const p = document.getElementById('inpPrice').value;
            const f = document.getElementById('inpFlavors').value.split(',').filter(x=>x.trim());
            const d = document.getElementById('inpDesc').value;
            const im = document.getElementById('previewImg').src;
            
            if(!n || !p) return toast("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è", true);
            
            db.products.unshift({ id: Date.now(), name: n, price: p, flavors: f, desc: d, image: im.startsWith('data') ? im : '' });
            renderAdmin(); renderGrid(); sync();
            
            document.getElementById('inpName').value = '';
            document.getElementById('previewImg').style.display='none';
        }

        async function savePromo() {
            const c = document.getElementById('pmCode').value.toUpperCase();
            const d = document.getElementById('pmDisc').value;
            if(!c || !d) return toast("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è", true);
            db.promos.unshift({ code: c, disc: d });
            renderAdmin(); sync();
            document.getElementById('pmCode').value = '';
        }

        function renderAdmin() {
            const gl = document.getElementById('goodsList'); gl.innerHTML = '';
            db.products.forEach(p => {
                const d = document.createElement('div');
                d.className = 'list-item';
                let im = p.image ? `<img src="${p.image}" class="li-img">` : '';
                d.innerHTML = `${im}<div class="li-info"><div class="li-title">${p.name}</div><div class="li-sub">${p.price} ‚Ç¨</div></div><div class="li-del" onclick="delItem('prod', ${p.id})">–£–¥–∞–ª–∏—Ç—å</div>`;
                gl.appendChild(d);
            });

            const pl = document.getElementById('promoList'); pl.innerHTML = '';
            db.promos.forEach(p => {
                const d = document.createElement('div');
                d.className = 'list-item';
                d.innerHTML = `<div class="li-info"><div class="li-title">${p.code}</div><div class="li-sub">-${p.disc}%</div></div><div class="li-del" onclick="delItem('promo', '${p.code}')">–£–¥–∞–ª–∏—Ç—å</div>`;
                pl.appendChild(d);
            });
        }

        async function delItem(type, id) {
            if(!confirm("–£–¥–∞–ª–∏—Ç—å?")) return;
            if(type==='prod') db.products = db.products.filter(x=>x.id !== id);
            else db.promos = db.promos.filter(x=>x.code !== id);
            renderAdmin(); renderGrid(); sync();
        }

        // Image
        document.getElementById('fileIn').onchange = (e) => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (ev) => {
                const i = new Image(); i.onload = () => {
                    const c = document.createElement('canvas'); const x = c.getContext('2d');
                    const m = 600; let w=i.width, h=i.height;
                    if(w>h){if(w>m){h*=m/w;w=m}}else{if(h>m){w*=m/h;h=m}}
                    c.width=w; c.height=h; x.drawImage(i,0,0,w,h);
                    document.getElementById('previewImg').src = c.toDataURL('image/jpeg', 0.85);
                    document.getElementById('previewImg').style.display='block';
                }; i.src = ev.target.result;
            }; r.readAsDataURL(f);
        }

        function toast(tx, err) {
            const t = document.getElementById('toast');
            t.innerHTML = err ? `<i class="fas fa-exclamation-triangle" style="color:#FF453A"></i> ${tx}` : `<i class="fas fa-check-circle" style="color:#30D158"></i> ${tx}`;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        document.getElementById('overlay').onclick = () => {
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('sheet').classList.remove('active');
        }
    </script>
</body>
</html>
