<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PARADISE ZENITH</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* --- CORE PALETTE --- */
            --primary: #6366f1;
            --accent: #d946ef;
            --success: #10b981;
            --danger: #ef4444;
            --bg-deep: #020617;
            --glass-card: rgba(15, 23, 42, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --glow: 0 0 20px rgba(99, 102, 241, 0.15);
        }

        [data-theme="light"] {
            --bg-deep: #f1f5f9;
            --glass-card: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.6);
            --text-main: #0f172a;
            --text-muted: #64748b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            min-height: 100vh;
            padding-bottom: 110px;
            overflow-x: hidden;
            transition: background 0.4s ease;
        }

        /* --- AURORA BACKGROUND (OPTIMIZED) --- */
        .aurora-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .aurora-blob {
            position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5;
            animation: float 20s infinite alternate ease-in-out;
        }
        .blob-1 { width: 300px; height: 300px; background: #6366f1; top: -50px; left: -50px; }
        .blob-2 { width: 350px; height: 350px; background: #d946ef; bottom: -50px; right: -50px; animation-delay: -5s; }
        .blob-3 { width: 200px; height: 200px; background: #3b82f6; top: 40%; left: 30%; opacity: 0.3; animation-duration: 25s; }
        
        @keyframes float { 0% { transform: translate(0, 0); } 100% { transform: translate(30px, 40px); } }

        /* --- UI COMPONENTS --- */
        .glass {
            background: var(--glass-card);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* HEADER */
        header {
            position: sticky; top: 10px; z-index: 50;
            margin: 0 12px; padding: 12px 20px;
            border-radius: 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .brand {
            font-size: 22px; font-weight: 900; letter-spacing: -0.5px;
            background: linear-gradient(135deg, #fff, #a5b4fc);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            display: flex; align-items: center; gap: 10px;
        }
        [data-theme="light"] .brand { background: linear-gradient(135deg, #4f46e5, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .controls { display: flex; gap: 8px; }
        .icon-btn {
            width: 40px; height: 40px; border-radius: 12px;
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: center;
            color: var(--text-main); font-size: 18px; cursor: pointer; transition: 0.2s;
        }
        .icon-btn:active { transform: scale(0.92); background: var(--primary); color: white; border-color: transparent; }

        /* LINKS */
        .links-wrapper { display: flex; gap: 10px; padding: 15px 12px; }
        .link-btn {
            flex: 1; padding: 14px; border-radius: 18px;
            text-decoration: none; color: var(--text-main); font-weight: 700;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 13px; position: relative; overflow: hidden;
        }
        .link-btn:active { transform: scale(0.98); }
        .link-btn i { color: var(--accent); }

        /* GRID */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 0 12px; }
        
        .card {
            border-radius: 24px; padding: 8px;
            display: flex; flex-direction: column; gap: 8px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .card:active { transform: scale(0.96); }

        .img-container {
            width: 100%; padding-top: 100%; position: relative;
            border-radius: 18px; overflow: hidden; background: rgba(0,0,0,0.2);
        }
        .prod-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .card:active .prod-img { transform: scale(1.1); }
        .no-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--text-muted); opacity: 0.5; font-size: 32px; }

        .card-info { padding: 4px 6px 8px; }
        .card-title { font-weight: 700; font-size: 14px; line-height: 1.3; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .card-price { font-weight: 900; font-size: 16px; color: var(--accent); text-shadow: var(--glow); }

        /* MODAL */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
            z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-backdrop.active { opacity: 1; pointer-events: all; }

        .sheet {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--bg-deep); /* Solid background to prevent transparency issues */
            border-top: 1px solid var(--glass-border);
            border-radius: 35px 35px 0 0; padding: 30px 24px;
            z-index: 101; transform: translateY(110%);
            transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            box-shadow: 0 -20px 50px rgba(0,0,0,0.5);
        }
        .sheet.active { transform: translateY(0); }

        .sheet-header { display: flex; gap: 20px; margin-bottom: 25px; }
        .sheet-thumb { width: 80px; height: 80px; border-radius: 20px; object-fit: cover; background: #222; }
        
        .flavors-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 25px; }
        .flavor-chip {
            padding: 10px 16px; border-radius: 12px; background: rgba(255,255,255,0.05);
            font-size: 13px; font-weight: 600; border: 1px solid transparent; transition: 0.2s; cursor: pointer;
        }
        .flavor-chip.selected { background: var(--text-main); color: var(--bg-deep); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255,255,255,0.2); }

        .promo-row { display: flex; gap: 10px; margin-bottom: 25px; background: rgba(255,255,255,0.03); padding: 5px; border-radius: 16px; border: 1px solid var(--glass-border); }
        .promo-input { flex: 1; background: transparent; border: none; padding: 0 10px; color: var(--text-main); font-family: 'Outfit'; font-weight: 600; outline: none; }
        .promo-btn { background: var(--text-main); color: var(--bg-deep); border: none; padding: 10px 15px; border-radius: 12px; font-weight: 800; font-size: 12px; cursor: pointer; }

        .checkout-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .qty-wrapper { display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.05); padding: 5px 10px; border-radius: 16px; }
        .qty-btn { width: 35px; height: 35px; border-radius: 10px; border: none; background: var(--text-main); color: var(--bg-deep); font-weight: 900; font-size: 18px; cursor: pointer; }
        .qty-val { font-weight: 800; font-size: 18px; min-width: 20px; text-align: center; }

        .total-price { text-align: right; }
        .price-final { font-size: 24px; font-weight: 900; color: var(--primary); text-shadow: var(--glow); }
        .price-old { font-size: 14px; text-decoration: line-through; color: var(--text-muted); opacity: 0; transition: 0.3s; }
        .price-old.visible { opacity: 1; }

        .main-btn {
            width: 100%; padding: 18px; border-radius: 18px; border: none;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: #fff; font-size: 16px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 10px 30px -5px rgba(99, 102, 241, 0.4);
            display: flex; justify-content: center; align-items: center; gap: 10px;
            cursor: pointer;
        }
        .main-btn:active { transform: scale(0.98); }

        /* --- ADMIN DASHBOARD (Cyber Style) --- */
        .admin-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0b0f19; z-index: 200; display: none;
            padding: 20px; overflow-y: auto;
        }
        .admin-overlay.open { display: block; animation: slideUp 0.3s; }

        .adm-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid #1e293b; }
        .adm-title { font-size: 24px; font-weight: 900; background: linear-gradient(90deg, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .adm-tabs { display: flex; gap: 10px; margin-bottom: 25px; background: #1e293b; padding: 5px; border-radius: 14px; }
        .adm-tab { flex: 1; padding: 10px; text-align: center; border-radius: 10px; font-weight: 700; font-size: 13px; color: #94a3b8; cursor: pointer; transition: 0.2s; }
        .adm-tab.active { background: #334155; color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

        .adm-section { display: none; }
        .adm-section.active { display: block; animation: fadeIn 0.3s; }

        .form-group { margin-bottom: 15px; }
        .form-label { font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; display: block; }
        .form-input { 
            width: 100%; background: #1e293b; border: 1px solid #334155; 
            color: #fff; padding: 14px; border-radius: 12px; outline: none; 
            font-family: 'Outfit'; font-size: 14px; transition: 0.2s; 
        }
        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }

        .photo-upload {
            height: 100px; border: 2px dashed #334155; border-radius: 14px;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            color: #64748b; margin-bottom: 20px; cursor: pointer; background: rgba(30, 41, 59, 0.5);
        }
        .photo-upload:hover { border-color: var(--primary); color: var(--primary); }

        .db-list { margin-top: 30px; border-top: 1px solid #1e293b; padding-top: 20px; }
        .db-item { display: flex; align-items: center; gap: 15px; background: #1e293b; padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #334155; }
        .db-thumb { width: 40px; height: 40px; border-radius: 8px; background: #0f172a; object-fit: cover; }
        
        .action-btn { width: 100%; padding: 15px; background: var(--primary); color: #fff; border: none; border-radius: 12px; font-weight: 800; text-transform: uppercase; cursor: pointer; }
        .del-btn { width: 32px; height: 32px; border-radius: 8px; background: rgba(239, 68, 68, 0.1); color: #ef4444; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: auto; }

        /* AUTH */
        .auth-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #020617; z-index: 2000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        
        /* TOAST */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: #1e293b; color: #fff; padding: 12px 24px; border-radius: 50px;
            font-weight: 600; display: flex; align-items: center; gap: 10px;
            z-index: 5000; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid #334155; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .toast.visible { transform: translateX(-50%) translateY(0); }
        .toast.success i { color: var(--success); }
        .toast.error i { color: var(--danger); }

        /* LOADER */
        .loader { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg-deep); z-index: 50; display: flex; align-items: center; justify-content: center; transition: 0.5s; }
        .spinner { width: 50px; height: 50px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideUp { from { opacity:0; transform: translateY(50px); } to { opacity:1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    </style>
</head>
<body>

    <div class="aurora-container">
        <div class="aurora-blob blob-1"></div>
        <div class="aurora-blob blob-2"></div>
        <div class="aurora-blob blob-3"></div>
    </div>

    <header class="glass">
        <div class="brand"><i class="fas fa-bolt"></i> PARADISE</div>
        <div class="controls">
            <div class="icon-btn" onclick="toggleTheme()" id="themeBtn"><i class="fas fa-moon"></i></div>
            <div class="icon-btn" onclick="openAuth()"><i class="fas fa-cog"></i></div>
        </div>
    </header>

    <div class="links-wrapper">
        <a href="https://t.me/sparadiseinfo" class="link-btn glass" target="_blank">
            <i class="fas fa-info-circle"></i> INFO
        </a>
        <a href="https://t.me/+N8WkPq6XQ6I5MjJk" class="link-btn glass" target="_blank">
            <i class="fas fa-paper-plane"></i> CHANNEL
        </a>
    </div>

    <div id="loader" class="loader"><div class="spinner"></div></div>

    <div class="grid" id="grid"></div>

    <div class="modal-backdrop" id="modalBackdrop"></div>
    <div class="sheet" id="sheet">
        <div class="sheet-header">
            <img src="" class="sheet-thumb" id="sImg">
            <div style="flex:1">
                <h2 id="sTitle" style="font-size:20px; line-height:1.2; margin-bottom:5px;">Product Name</h2>
                <div id="sDesc" style="font-size:13px; color:var(--text-muted); max-height:40px; overflow-y:auto;"></div>
            </div>
        </div>

        <div style="font-size:11px; font-weight:800; color:var(--text-muted); text-transform:uppercase; margin-bottom:10px;">–í–∫—É—Å—ã</div>
        <div class="flavors-grid" id="sFlavors"></div>

        <div class="promo-row">
            <input type="text" class="promo-input" id="promoInput" placeholder="–ï—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥?">
            <button class="promo-btn" onclick="applyPromo()">OK</button>
        </div>

        <div class="checkout-bar">
            <div class="qty-wrapper">
                <button class="qty-btn" onclick="updQty(-1)">-</button>
                <div class="qty-val" id="sQty">1</div>
                <button class="qty-btn" onclick="updQty(1)">+</button>
            </div>
            <div class="total-price">
                <div class="price-old" id="sOldPrice">0 ‚Ç¨</div>
                <div class="price-final" id="sTotal">0 ‚Ç¨</div>
            </div>
        </div>

        <button class="main-btn" id="orderBtn">
            –ó–ê–ö–ê–ó–ê–¢–¨ <i class="fas fa-arrow-right"></i>
        </button>
    </div>

    <div class="admin-overlay" id="adminPanel">
        <div class="adm-header">
            <div class="adm-title">COMMAND CENTER</div>
            <button onclick="toggleAdmin(false)" style="background:none; border:none; color:#94a3b8; font-size:24px;">&times;</button>
        </div>

        <div class="adm-tabs">
            <div class="adm-tab active" onclick="switchTab('goods', this)">–¢–û–í–ê–†–´</div>
            <div class="adm-tab" onclick="switchTab('promos', this)">–ü–†–û–ú–û–ö–û–î–´</div>
        </div>

        <div class="adm-section active" id="sec-goods">
            <div class="photo-upload" onclick="document.getElementById('fileIn').click()">
                <i class="fas fa-camera" style="font-size:24px; margin-bottom:10px;"></i>
                <span style="font-size:12px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</span>
                <img id="previewImg" style="display:none; width:60px; height:60px; object-fit:cover; border-radius:10px; margin-top:10px;">
                <input type="file" id="fileIn" hidden accept="image/*">
            </div>

            <div class="form-group"><span class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</span><input id="inpName" class="form-input"></div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><span class="form-label">–¶–µ–Ω–∞ (‚Ç¨)</span><input id="inpPrice" type="number" class="form-input"></div>
                <div class="form-group" style="flex:2"><span class="form-label">–í–∫—É—Å—ã (CSV)</span><input id="inpFlavors" class="form-input"></div>
            </div>
            
            <button class="action-btn" onclick="saveProduct()">–î–û–ë–ê–í–ò–¢–¨ –í –ë–ê–ó–£</button>
            <div class="db-list" id="goodsList"></div>
        </div>

        <div class="adm-section" id="sec-promos">
            <div class="form-group"><span class="form-label">–ö–æ–¥ –∫—É–ø–æ–Ω–∞</span><input id="pmCode" class="form-input" style="text-transform:uppercase"></div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><span class="form-label">–°–∫–∏–¥–∫–∞ %</span><input id="pmDisc" type="number" class="form-input"></div>
                <div class="form-group" style="flex:1"><span class="form-label">–õ–∏–º–∏—Ç</span><input id="pmLimit" type="number" class="form-input" placeholder="100"></div>
            </div>
            
            <button class="action-btn" style="background:var(--success)" onclick="savePromo()">–°–û–ó–î–ê–¢–¨ –ö–£–ü–û–ù</button>
            <div class="db-list" id="promosList"></div>
        </div>
    </div>

    <div class="auth-modal" id="authModal">
        <i class="fas fa-fingerprint" style="font-size:60px; color:var(--primary); margin-bottom:30px;"></i>
        <input type="password" id="passInput" class="form-input" style="width:200px; text-align:center; margin-bottom:20px;" placeholder="ACCESS CODE">
        <div style="display:flex; gap:10px; width:200px;">
            <button class="action-btn" style="background:#334155" onclick="document.getElementById('authModal').style.display='none'">BACK</button>
            <button class="action-btn" onclick="checkPass()">ENTER</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // === CONFIGURATION ===
        const BIN_ID = "696ea19bd0ea881f4076e7ce";
        const API_KEY = "$2a$10$L2N3z0hcYt/KjMIcI402euuF0nMvX.RMLI8RCugRIyy6/NX7K3QXy";
        const ADMIN_PASS = "Inn2708inNfnaf1234";
        const TELEGRAM_USER = "Lacky337"; 

        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        // State
        let db = { products: [], promos: [] };
        let currentProduct = null;
        let qty = 1;
        let selectedFlavor = '';
        let activePromo = null;

        // Init
        window.onload = async () => {
            // Auto theme from Telegram
            if(tg.colorScheme === 'light') toggleTheme(true);
            await loadData();
        };

        // --- CORE FUNCTIONS ---
        async function loadData() {
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { 'X-Master-Key': API_KEY } });
                if(res.ok) {
                    const data = await res.json();
                    if(Array.isArray(data.record)) {
                        // Migration from old array structure
                        db.products = data.record;
                        db.promos = [];
                    } else {
                        db = data.record;
                        if(!db.products) db.products = [];
                        if(!db.promos) db.promos = [];
                    }
                }
                renderShop();
                renderAdminLists();
            } catch(e) { console.error("DB Error", e); }
            
            setTimeout(() => {
                document.getElementById('loader').style.opacity = '0';
                setTimeout(()=>document.getElementById('loader').style.display='none', 500);
            }, 800);
        }

        async function syncData() {
            showToast("Syncing...", "info");
            try {
                await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                    body: JSON.stringify(db)
                });
                showToast("Saved!", "success");
            } catch(e) { showToast("Save Error!", "error"); }
        }

        // --- SHOP LOGIC ---
        function renderShop() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            if(!db.products.length) grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:50px;opacity:0.5">No products yet</div>';

            db.products.forEach(p => {
                const el = document.createElement('div');
                el.className = 'card glass';
                let im = p.image ? `<img src="${p.image}">` : `<i class="fas fa-box"></i>`;
                el.innerHTML = `
                    <div class="img-container">${p.image ? im : '<div class="no-img"><i class="fas fa-box"></i></div>'}</div>
                    <div class="card-info">
                        <div class="card-title">${p.name}</div>
                        <div class="card-price">${p.price} ‚Ç¨</div>
                    </div>
                `;
                el.onclick = () => openSheet(p);
                grid.appendChild(el);
            });
        }

        function openSheet(p) {
            currentProduct = p; qty = 1; activePromo = null;
            document.getElementById('sImg').src = p.image || '';
            document.getElementById('sTitle').innerText = p.name;
            document.getElementById('sDesc').innerText = p.desc || '';
            document.getElementById('promoInput').value = '';
            
            const flavContainer = document.getElementById('sFlavors');
            flavContainer.innerHTML = '';
            
            if(p.flavors && p.flavors.length) {
                selectedFlavor = p.flavors[0];
                p.flavors.forEach(f => {
                    const chip = document.createElement('div');
                    chip.className = `flavor-chip ${f === selectedFlavor ? 'selected' : ''}`;
                    chip.innerText = f;
                    chip.onclick = () => {
                        selectedFlavor = f;
                        document.querySelectorAll('.flavor-chip').forEach(c => c.classList.remove('selected'));
                        chip.classList.add('selected');
                        tg.HapticFeedback.selectionChanged();
                    };
                    flavContainer.appendChild(chip);
                });
            } else {
                selectedFlavor = "Standard";
                flavContainer.innerHTML = '<span style="opacity:0.5; font-size:12px">–ù–µ—Ç –≤—ã–±–æ—Ä–∞</span>';
            }
            
            updateCalc();
            document.getElementById('modalBackdrop').classList.add('active');
            document.getElementById('sheet').classList.add('active');
            tg.HapticFeedback.impactOccurred('medium');
        }

        function updQty(v) {
            if(qty + v < 1) return;
            qty += v;
            document.getElementById('sQty').innerText = qty;
            updateCalc();
            tg.HapticFeedback.selectionChanged();
        }

        function applyPromo() {
            const code = document.getElementById('promoInput').value.trim().toUpperCase();
            if(!code) return;
            
            const found = db.promos.find(x => x.code === code);
            if(found) {
                if(found.limit > 0 && (found.used || 0) >= found.limit) {
                    showToast("–õ–∏–º–∏—Ç –∫—É–ø–æ–Ω–∞ –∏—Å—á–µ—Ä–ø–∞–Ω", "error");
                    return;
                }
                activePromo = found;
                showToast(`–°–∫–∏–¥–∫–∞ -${found.discount}%!`, "success");
                tg.HapticFeedback.notificationOccurred('success');
                updateCalc();
            } else {
                showToast("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥", "error");
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        function updateCalc() {
            let base = parseFloat(currentProduct.price) * qty;
            const finalEl = document.getElementById('sTotal');
            const oldEl = document.getElementById('sOldPrice');
            
            if(activePromo) {
                const discounted = base * (1 - activePromo.discount/100);
                finalEl.innerText = discounted.toFixed(2) + ' ‚Ç¨';
                oldEl.innerText = base.toFixed(2) + ' ‚Ç¨';
                oldEl.classList.add('visible');
            } else {
                finalEl.innerText = base.toFixed(2) + ' ‚Ç¨';
                oldEl.classList.remove('visible');
            }
        }

        document.getElementById('orderBtn').onclick = () => {
            let finalPrice = parseFloat(currentProduct.price) * qty;
            if(activePromo) finalPrice = finalPrice * (1 - activePromo.discount/100);

            let msg = `üî• *–ó–ê–ö–ê–ó PARADISE*\n\n` +
                      `üì¶ *–¢–æ–≤–∞—Ä:* ${currentProduct.name}\n` +
                      `üçì *–í–∫—É—Å:* ${selectedFlavor}\n` +
                      `üî¢ *–ö–æ–ª-–≤–æ:* ${qty}\n`;
            
            if(activePromo) msg += `üéü *–ü—Ä–æ–º–æ:* ${activePromo.code} (-${activePromo.discount}%)\n`;
            
            msg += `üí∞ *–°—É–º–º–∞:* ${finalPrice.toFixed(2)} ‚Ç¨`;

            const url = `https://t.me/${TELEGRAM_USER}?text=${encodeURIComponent(msg)}`;
            try { tg.openTelegramLink(url); } catch(e) { window.open(url, '_blank'); }
            tg.close();
        };

        // --- ADMIN SYSTEM ---
        function openAuth() { document.getElementById('authModal').style.display = 'flex'; }
        
        function checkPass() {
            if(document.getElementById('passInput').value === ADMIN_PASS) {
                document.getElementById('authModal').style.display = 'none';
                toggleAdmin(true);
            } else {
                showToast("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å", "error");
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        function toggleAdmin(show) {
            const p = document.getElementById('adminPanel');
            if(show) { p.classList.add('open'); renderAdminLists(); }
            else { p.classList.remove('open'); }
        }

        function switchTab(t, btn) {
            document.querySelectorAll('.adm-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.adm-tab').forEach(b => b.classList.remove('active'));
            document.getElementById('sec-'+t).classList.add('active');
            btn.classList.add('active');
        }

        async function saveProduct() {
            const n = document.getElementById('inpName').value;
            const p = document.getElementById('inpPrice').value;
            const f = document.getElementById('inpFlavors').value.split(',').filter(x=>x.trim());
            const img = document.getElementById('previewImg').src;

            if(!n || !p) return showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è", "error");

            db.products.unshift({
                id: Date.now(), name: n, price: p, flavors: f, 
                image: img.startsWith('data') ? img : ''
            });

            renderAdminLists(); renderShop(); syncData();
            // Clear inputs
            document.getElementById('inpName').value = '';
        }

        async function savePromo() {
            const c = document.getElementById('pmCode').value.toUpperCase().trim();
            const d = document.getElementById('pmDisc').value;
            const l = document.getElementById('pmLimit').value;

            if(!c || !d) return showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è", "error");

            // Remove existing if same code
            db.promos = db.promos.filter(x => x.code !== c);
            
            db.promos.unshift({ code: c, discount: parseInt(d), limit: parseInt(l) || 9999, used: 0 });
            
            renderAdminLists(); syncData();
            document.getElementById('pmCode').value = '';
        }

        function renderAdminLists() {
            // Goods
            const gl = document.getElementById('goodsList');
            gl.innerHTML = '';
            db.products.forEach(p => {
                const div = document.createElement('div');
                div.className = 'db-item';
                div.innerHTML = `
                    <img src="${p.image || ''}" class="db-thumb">
                    <div style="flex:1">
                        <div style="font-weight:700; font-size:14px; color:#fff">${p.name}</div>
                        <div style="font-size:12px; color:#94a3b8">${p.price} ‚Ç¨</div>
                    </div>
                    <div class="del-btn" onclick="delItem('product', ${p.id})"><i class="fas fa-trash"></i></div>
                `;
                gl.appendChild(div);
            });

            // Promos
            const pl = document.getElementById('promosList');
            pl.innerHTML = '';
            db.promos.forEach(p => {
                const div = document.createElement('div');
                div.className = 'db-item';
                div.innerHTML = `
                    <div style="flex:1">
                        <div style="font-weight:700; color:#fff; letter-spacing:1px;">${p.code}</div>
                        <div style="font-size:12px; color:#10b981">-${p.discount}% (Lim: ${p.limit})</div>
                    </div>
                    <div class="del-btn" onclick="delItem('promo', '${p.code}')"><i class="fas fa-trash"></i></div>
                `;
                pl.appendChild(div);
            });
        }

        async function delItem(type, id) {
            if(!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
            if(type === 'product') db.products = db.products.filter(x => x.id !== id);
            if(type === 'promo') db.promos = db.promos.filter(x => x.code !== id);
            
            renderAdminLists(); renderShop(); syncData();
        }

        // --- UTILS ---
        document.getElementById('fileIn').onchange = (e) => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (ev) => {
                const i = new Image(); i.onload = () => {
                    const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                    const m = 600; let w=i.width, h=i.height;
                    if(w>h){if(w>m){h*=m/w;w=m}}else{if(h>m){w*=m/h;h=m}}
                    c.width=w; c.height=h; ctx.drawImage(i,0,0,w,h);
                    const d = c.toDataURL('image/jpeg', 0.85);
                    document.getElementById('previewImg').src = d;
                    document.getElementById('previewImg').style.display = 'block';
                }; i.src = ev.target.result;
            }; r.readAsDataURL(f);
        }

        function toggleTheme(forceLight = false) {
            const body = document.body;
            const btn = document.getElementById('themeBtn');
            if(body.getAttribute('data-theme') === 'dark' || forceLight) {
                body.setAttribute('data-theme', 'light');
                btn.innerHTML = '<i class="fas fa-moon"></i>';
                tg.setHeaderColor('#f1f5f9');
            } else {
                body.setAttribute('data-theme', 'dark');
                btn.innerHTML = '<i class="fas fa-sun"></i>';
                tg.setHeaderColor('#020617');
            }
        }

        function showToast(txt, type) {
            const t = document.getElementById('toast');
            t.className = `toast visible ${type}`;
            t.innerHTML = type === 'success' ? `<i class="fas fa-check-circle"></i> ${txt}` : 
                          type === 'error' ? `<i class="fas fa-exclamation-triangle"></i> ${txt}` : 
                          `<i class="fas fa-info-circle"></i> ${txt}`;
            setTimeout(() => t.classList.remove('visible'), 2500);
        }

        document.getElementById('modalBackdrop').onclick = () => {
            document.getElementById('modalBackdrop').classList.remove('active');
            document.getElementById('sheet').classList.remove('active');
        }
    </script>
</body>
</html>
