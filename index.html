<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CONCEPT SPACE | INFINITY ULTRA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* =================================================================
           1. ULTRA CORE CONFIGURATION
           ================================================================= */
        :root {
            /* DEEP SPACE PALETTE */
            --bg-body: #050505;
            --bg-panel: #0e0e0e;
            --bg-element: #181818;
            --bg-nav: rgba(5, 5, 5, 0.85);

            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #555555;

            /* NEON ACCENTS */
            --accent-green: #00ff9d;       
            --accent-green-glow: rgba(0, 255, 157, 0.4);
            --accent-green-dim: rgba(0, 255, 157, 0.1);
            
            --accent-purple: #bc13fe;      
            --accent-purple-glow: rgba(188, 19, 254, 0.4);
            
            --accent-red: #ff2a6d;         
            --accent-blue: #00f0ff;        
            --accent-gold: #ffd700;        

            /* GLASSMORPHISM PREMIUM */
            --glass: rgba(255, 255, 255, 0.03);
            --glass-high: rgba(255, 255, 255, 0.08);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --glass-border-light: 1px solid rgba(255, 255, 255, 0.15);
            
            /* UI PROPS */
            --shadow-card: 0 10px 40px -10px rgba(0, 0, 0, 0.8);
            --shadow-glow: 0 0 20px var(--accent-green-dim);
            --radius-box: 20px;
            --radius-btn: 16px;

            /* ANIMATIONS */
            --ease-elastic: cubic-bezier(0.34, 1.56, 0.64, 1);
            --ease-smooth: cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* RESET */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, Roboto, sans-serif; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex; flex-direction: column;
            user-select: none;
        }

        /* SPACE BACKGROUND & PARTICLES */
        #star-canvas {
            position: fixed; inset: 0; z-index: -1; pointer-events: none;
            background: radial-gradient(circle at 50% 120%, #0d1a12 0%, #000 60%);
        }
        
        /* CLICK PARTICLE EFFECT */
        .click-particle {
            position: absolute; pointer-events: none; width: 6px; height: 6px;
            background: var(--accent-green); border-radius: 50%;
            animation: particle-fade 0.8s forwards ease-out; z-index: 9999;
            box-shadow: 0 0 10px var(--accent-green);
        }
        @keyframes particle-fade {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0); opacity: 0; top: -20px; }
        }

        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 0; height: 0; display: none; }

        /* =================================================================
           2. LOADER COMPONENT (UPDATED)
           ================================================================= */
        #app-loader {
            position: fixed; inset: 0; background: #000; z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.6s var(--ease-smooth);
        }
        .loader-orbit {
            width: 80px; height: 80px; border: 2px solid rgba(255,255,255,0.05);
            border-radius: 50%; border-top-color: var(--accent-green); border-bottom-color: var(--accent-purple);
            animation: spin 1.5s linear infinite; box-shadow: 0 0 50px rgba(0,255,157,0.1);
            position: relative;
        }
        .loader-orbit::after {
            content:''; position: absolute; inset: 10px; border-radius: 50%;
            border: 2px solid transparent; border-left-color: var(--accent-blue);
            animation: spin 1s reverse linear infinite;
        }
        .loader-text {
            margin-top: 30px; font-size: 14px; font-weight: 900; letter-spacing: 6px;
            background: linear-gradient(90deg, var(--accent-green), #fff, var(--accent-blue)); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: shine 3s infinite linear; background-size: 200%;
        }

        /* =================================================================
           3. HEADER & SEARCH
           ================================================================= */
        .header {
            padding: 15px 20px; background: rgba(5,5,5,0.7); backdrop-filter: blur(25px);
            border-bottom: var(--glass-border); z-index: 100; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { 
            font-size: 18px; font-weight: 900; letter-spacing: -0.5px; 
            display: flex; align-items: center; gap: 10px; text-transform: uppercase; 
            text-shadow: 0 0 15px rgba(0,255,157,0.3);
        }
        .brand i { color: var(--accent-green); filter: drop-shadow(0 0 8px var(--accent-green)); animation: float 3s ease-in-out infinite; }
        
        .status-badge {
            font-size: 10px; font-weight: 700; background: var(--glass-high);
            padding: 5px 12px; border-radius: 20px; border: var(--glass-border-light);
            display: flex; align-items: center; gap: 6px; color: var(--text-secondary);
        }
        .status-dot { width: 6px; height: 6px; background: var(--accent-green); border-radius: 50%; box-shadow: 0 0 8px var(--accent-green); animation: pulse 2s infinite; }

        /* =================================================================
           4. MAIN CONTENT AREA
           ================================================================= */
        .content-area {
            flex: 1; overflow-y: auto; overflow-x: hidden; padding-bottom: 110px;
            scroll-behavior: smooth; position: relative;
        }

        /* SEARCH BAR */
        .search-wrapper {
            position: sticky; top: 0; z-index: 90; padding: 15px 20px;
            background: linear-gradient(180deg, rgba(5,5,5,0.98) 0%, rgba(5,5,5,0) 100%);
        }
        .search-box { position: relative; width: 100%; transform: translateZ(0); }
        .search-input {
            width: 100%; height: 50px; background: var(--bg-element); border: var(--glass-border);
            border-radius: 18px; padding: 0 15px 0 50px; color: #fff; font-size: 14px;
            transition: 0.4s var(--ease-smooth); box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .search-input::placeholder { color: #555; font-weight: 500; }
        .search-input:focus { 
            border-color: var(--accent-green); 
            box-shadow: 0 0 0 4px var(--accent-green-dim); 
            background: #202020; transform: scale(1.01);
        }
        .search-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #666; font-size: 16px; transition: 0.3s; }
        .search-input:focus + .search-icon { color: var(--accent-green); }

        /* BANNERS */
        .promo-slider {
            display: flex; gap: 14px; overflow-x: auto; padding: 5px 20px 25px 20px;
            scroll-snap-type: x mandatory; scroll-behavior: smooth;
        }
        .promo-slide {
            min-width: 90%; height: 200px; background: #111; border-radius: 24px;
            position: relative; overflow: hidden; scroll-snap-align: center;
            border: var(--glass-border); box-shadow: var(--shadow-card);
            transition: 0.3s;
        }
        .promo-slide:active { transform: scale(0.98); }
        .promo-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; transition: transform 0.6s; }
        .promo-overlay {
            position: absolute; inset: 0; padding: 25px;
            background: linear-gradient(to top, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 60%);
            display: flex; flex-direction: column; justify-content: flex-end; align-items: flex-start;
        }
        .promo-tag {
            font-size: 10px; font-weight: 900; color: #000; padding: 5px 10px;
            border-radius: 8px; margin-bottom: 8px; text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .promo-title {
            font-size: 28px; font-weight: 900; line-height: 0.95; text-transform: uppercase;
            text-shadow: 0 4px 20px rgba(0,0,0,0.8); letter-spacing: -1px; transform:translateY(0);
        }

        /* CATEGORIES */
        .cat-list { display: flex; gap: 10px; overflow-x: auto; padding: 0 20px 20px 20px; }
        .cat-item {
            padding: 12px 24px; background: rgba(30,30,30,0.6); border-radius: 30px;
            font-size: 13px; font-weight: 700; color: #888; border: var(--glass-border);
            white-space: nowrap; transition: 0.3s var(--ease-smooth); cursor: pointer; backdrop-filter: blur(10px);
        }
        .cat-item.active {
            background: var(--accent-green); color: #000; border-color: var(--accent-green);
            box-shadow: 0 5px 20px var(--accent-green-dim); transform: scale(1.05);
        }

        /* PRODUCT GRID */
        .grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 0 20px;
            animation: fadeIn 0.6s ease;
        }
        .card {
            background: var(--bg-panel); border-radius: var(--radius-box); overflow: hidden;
            border: var(--glass-border); position: relative; display: flex; flex-direction: column;
            transition: all 0.3s var(--ease-smooth); box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .card:active { transform: scale(0.96); }

        .card-top { position: relative; width: 100%; padding-top: 110%; background: #080808; overflow:hidden;}
        .card-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition:0.5s;}
        .card:hover .card-img { transform: scale(1.1); }
        
        .card-status {
            position: absolute; top: 12px; left: 12px; display: flex; flex-direction: column; gap: 5px; z-index: 5;
        }
        .badge {
            font-size: 9px; font-weight: 900; padding: 4px 8px; border-radius: 6px;
            color: #fff; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1); text-transform: uppercase; letter-spacing: 0.5px;
        }
        .badge.hot { color: var(--accent-red); border-color: rgba(255,42,109,0.3); box-shadow: 0 0 10px rgba(255,42,109,0.2); }
        .badge.sale { color: var(--accent-purple); border-color: rgba(157,0,255,0.3); }

        .fav-btn {
            position: absolute; top: 10px; right: 10px; width: 36px; height: 36px;
            background: rgba(0,0,0,0.4); border-radius: 50%; backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center; border: var(--glass-border);
            color: #fff; transition: 0.3s; z-index: 5;
        }
        .fav-btn.active { background: #fff; color: var(--accent-red); transform: scale(1.1) rotate(360deg); box-shadow: 0 5px 15px rgba(255,255,255,0.2); }

        .card-body { padding: 16px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; background: linear-gradient(180deg, var(--bg-panel) 0%, #151515 100%); }
        .card-title { font-size: 13px; font-weight: 600; line-height: 1.4; color: #eee; margin-bottom: 12px; opacity: 0.9; }
        .card-price-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .price { font-size: 18px; font-weight: 900; color: var(--accent-green); text-shadow: 0 0 20px var(--accent-green-dim); letter-spacing: -0.5px; }
        .add-icon {
            width: 32px; height: 32px; background: rgba(255,255,255,0.05); border-radius: 12px;
            display: flex; align-items: center; justify-content: center; color: #fff; border: 1px solid transparent; transition: 0.3s;
        }
        .card:hover .add-icon { background: var(--accent-green); color: #000; border-color: var(--accent-green); box-shadow: 0 0 15px var(--accent-green-dim); }

        /* =================================================================
           5. PROFILE & LINKS STYLES
           ================================================================= */
        .profile-header {
            background: linear-gradient(180deg, rgba(255,255,255,0.03), transparent);
            border-radius: 28px; padding: 40px 20px; text-align: center;
            border: var(--glass-border); margin-bottom: 25px;
            position: relative; overflow: hidden;
        }
        .profile-header::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, var(--accent-green-dim) 0%, transparent 60%);
            opacity: 0.4; pointer-events: none; animation: pulse-slow 5s infinite ease-in-out;
        }
        
        .profile-avatar-box {
            width: 96px; height: 96px; border-radius: 50%; background: #000;
            border: 2px solid var(--accent-green); margin: 0 auto 18px;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; box-shadow: 0 0 40px var(--accent-green-dim);
            position: relative; z-index: 2;
        }
        .profile-avatar-img { width: 100%; height: 100%; object-fit: cover; }
        .profile-icon { font-size: 38px; color: #fff; }
        
        .profile-name { font-size: 26px; font-weight: 900; margin-bottom: 6px; color: #fff; position: relative; z-index: 2; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .profile-tag { 
            color: var(--accent-green); font-size: 14px; font-weight: 700; letter-spacing: 1px; 
            margin-bottom: 5px; position: relative; z-index: 2; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .profile-id { color: #555; font-size: 11px; font-weight: 600; position: relative; z-index: 2; }

        .social-block {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;
        }
        .social-btn {
            background: var(--bg-element); border: var(--glass-border); border-radius: 20px;
            padding: 22px 15px; display: flex; flex-direction: column; align-items: center; gap: 10px;
            transition: 0.3s; position: relative; overflow: hidden;
        }
        .social-btn:active { transform: scale(0.96); opacity: 0.8; }
        .social-btn i { font-size: 26px; color: #fff; transition: 0.3s; }
        .social-btn span { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; color: #888; }
        .social-btn.main { border-color: rgba(0, 255, 157, 0.2); background: radial-gradient(circle at top right, rgba(0,255,157,0.05), transparent); }
        .social-btn.main i { color: var(--accent-green); filter: drop-shadow(0 0 12px var(--accent-green)); }
        .social-btn.info { border-color: rgba(0, 204, 255, 0.2); background: radial-gradient(circle at top left, rgba(0,204,255,0.05), transparent); }
        .social-btn.info i { color: var(--accent-blue); filter: drop-shadow(0 0 12px var(--accent-blue)); }

        .menu-list { background: #121212; border-radius: 22px; border: var(--glass-border); overflow: hidden; }
        .menu-item {
            padding: 20px; border-bottom: 1px solid #1e1e1e; display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.01); transition: 0.2s;
        }
        .menu-item:active { background: rgba(255,255,255,0.05); }
        .menu-item:last-child { border-bottom: none; }
        .menu-left { display: flex; gap: 18px; align-items: center; font-size: 15px; font-weight: 600; color: #ddd; }
        .menu-left i { width: 22px; text-align: center; color: #666; font-size: 18px; transition:0.3s; }
        .menu-item:active .menu-left i { transform: scale(1.2); color: #fff; }

        /* =================================================================
           6. NAVIGATION BAR (GLOW UP)
           ================================================================= */
        .nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 95px;
            background: var(--bg-nav); backdrop-filter: blur(30px);
            border-top: var(--glass-border); z-index: 200;
            display: flex; justify-content: space-around; padding-top: 18px;
            box-shadow: 0 -15px 50px rgba(0,0,0,0.7);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 7px;
            color: #555; font-size: 10px; font-weight: 700; width: 65px; position: relative;
            transition: 0.3s;
        }
        .nav-item i { font-size: 24px; transition: 0.4s var(--ease-elastic); }
        .nav-item.active { color: #fff; }
        .nav-item.active i { 
            transform: translateY(-6px) scale(1.1); 
            color: var(--accent-green);
            filter: drop-shadow(0 0 15px var(--accent-green)); 
        }
        
        .nav-counter {
            position: absolute; top: -6px; right: 12px; background: var(--accent-red);
            color: #fff; font-size: 10px; min-width: 20px; height: 20px; border-radius: 20px;
            display: flex; align-items: center; justify-content: center; border: 3px solid var(--bg-nav);
            transform: scale(0); transition: 0.4s var(--ease-elastic); box-shadow: 0 0 10px var(--accent-red); font-weight:800;
        }
        .nav-counter.visible { transform: scale(1); }

        /* =================================================================
           7. SHEETS & MODALS
           ================================================================= */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px);
            z-index: 300; opacity: 0; pointer-events: none; transition: 0.4s;
        }
        .overlay.show { opacity: 1; pointer-events: all; }

        .sheet {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #0f0f0f;
            border-radius: 35px 35px 0 0; z-index: 301; border-top: 1px solid rgba(255,255,255,0.1);
            transform: translateY(110%); transition: transform 0.5s var(--ease-elastic);
            padding: 30px; display: flex; flex-direction: column; max-height: 88vh;
            box-shadow: 0 -20px 80px rgba(0,0,0,0.9);
        }
        .sheet.show { transform: translateY(0); }
        .sheet::before {
            content:''; position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            width: 40px; height: 4px; background: #333; border-radius: 4px;
        }

        /* DETAIL SHEET */
        .detail-header { display: flex; gap: 20px; margin-bottom: 25px; }
        .detail-img { width: 120px; height: 120px; border-radius: 24px; object-fit: cover; background: #222; border: var(--glass-border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .detail-meta { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        
        .opt-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; }
        .opt-chip {
            padding: 12px 20px; background: #1a1a1a; border: 1px solid #333; border-radius: 14px;
            font-size: 13px; color: #888; font-weight: 700; transition: 0.2s;
        }
        .opt-chip.selected { 
            background: var(--accent-green-dim); border-color: var(--accent-green); 
            color: var(--accent-green); box-shadow: 0 0 20px var(--accent-green-dim); 
        }

        .btn-main {
            width: 100%; height: 56px; background: var(--accent-green); color: #000;
            border: none; border-radius: 18px; font-weight: 900; font-size: 15px;
            letter-spacing: 0.5px; text-transform: uppercase; display: flex;
            justify-content: center; align-items: center; gap: 10px;
            box-shadow: 0 8px 30px var(--accent-green-dim); transition: 0.3s;
            position: relative; overflow: hidden;
        }
        .btn-main::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: rotate(45deg) translateY(-100%); animation: shimmer 3s infinite;
        }
        .btn-main:active { transform: scale(0.98); opacity: 0.9; }
        
        /* CART SHEET */
        .cart-list { flex: 1; overflow-y: auto; margin-bottom: 20px; }
        .cart-item {
            display: flex; align-items: center; gap: 15px; padding: 14px;
            background: rgba(255,255,255,0.03); border-radius: 20px; margin-bottom: 12px;
            border: var(--glass-border); position: relative;
        }

        /* STATUS SHEET STYLES */
        .status-level-bar {
            width: 100%; height: 10px; background: #222; border-radius: 10px; overflow: hidden; margin: 15px 0 8px; border: 1px solid #333;
        }
        .status-progress { height: 100%; background: linear-gradient(90deg, var(--accent-green), var(--accent-blue)); width: 0%; transition: 1s var(--ease-elastic); box-shadow: 0 0 15px var(--accent-green); }
        .privilege-item { display: flex; gap: 12px; margin-bottom: 12px; align-items: center; font-size: 13px; font-weight: 600; }
        .privilege-item i { color: var(--accent-gold); width: 20px; text-align: center; font-size: 14px; filter: drop-shadow(0 0 5px var(--accent-gold)); }

        /* DASHBOARD CHARTS */
        .chart-bar-container { display: flex; align-items: flex-end; gap: 8px; height: 100px; padding-top: 20px; border-bottom: 1px solid #333; margin-bottom: 10px; }
        .chart-col { flex: 1; background: var(--accent-green-dim); border-radius: 4px 4px 0 0; position: relative; transition: height 1s; min-height: 5px; }
        .chart-col:hover { background: var(--accent-green); box-shadow: 0 0 10px var(--accent-green); }

        /* =================================================================
           8. ADMIN PANEL
           ================================================================= */
        .admin-float-btn {
            position: fixed; bottom: 110px; right: 20px; width: 58px; height: 58px;
            background: rgba(20,20,20,0.9); backdrop-filter: blur(20px);
            border-radius: 50%; color: #666; display: flex; align-items: center; justify-content: center;
            border: 1px solid #444; z-index: 150; transition: 0.3s; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            animation: pulse-border 3s infinite;
        }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(0,255,157,0.3); } 70% { box-shadow: 0 0 0 15px rgba(0,255,157,0); } 100% { box-shadow: 0 0 0 0 rgba(0,255,157,0); } }
        
        .admin-float-btn:active { color: var(--accent-green); border-color: var(--accent-green); transform: scale(0.9); }

        .admin-panel {
            position: fixed; inset: 0; background: #000; z-index: 500;
            transform: translateX(100%); transition: 0.4s var(--ease-smooth);
            display: flex; flex-direction: column;
        }
        .admin-panel.open { transform: translateX(0); }
        
        .adm-nav { padding: 25px 20px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; background: #080808; }
        .adm-tabs { display: flex; background: #080808; border-bottom: 1px solid #222; overflow-x: auto; }
        .adm-tab { flex: 1; padding: 16px; text-align: center; font-size: 11px; font-weight: 800; color: #555; letter-spacing: 1px; min-width: 80px; white-space: nowrap; transition:0.3s; }
        .adm-tab.active { color: var(--accent-green); border-bottom: 2px solid var(--accent-green); background: rgba(0,255,157,0.05); text-shadow: 0 0 10px var(--accent-green-dim); }

        .adm-content { flex: 1; overflow-y: auto; padding: 20px; }
        .adm-card { background: #111; padding: 20px; border-radius: 20px; border: 1px solid #222; margin-bottom: 15px; }
        .adm-input { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 15px; border-radius: 14px; margin-bottom: 12px; font-size: 13px; transition:0.3s; }
        .adm-input:focus { border-color: var(--accent-green); box-shadow: 0 0 15px var(--accent-green-dim); }

        .adm-file-label {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            background: #1a1a1a; padding: 20px; border: 1px dashed #444; border-radius: 14px;
            color: #888; font-size: 12px; margin-bottom: 12px; transition: 0.2s;
        }
        .adm-file-label:active { background: #222; border-color: #666; }

        /* TOAST NOTIFICATION */
        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: rgba(10,10,10,0.9); backdrop-filter: blur(20px); border: 1px solid #333;
            padding: 16px 30px; border-radius: 40px; display: flex; align-items: center; gap: 12px;
            z-index: 9999; transition: 0.5s var(--ease-elastic); opacity: 0; box-shadow: 0 20px 60px rgba(0,0,0,0.9);
        }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        #toast.success i { color: var(--accent-green); text-shadow: 0 0 10px var(--accent-green); }
        #toast.error i { color: var(--accent-red); text-shadow: 0 0 10px var(--accent-red); }

        /* ANIMATIONS */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.9); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        @keyframes shine { from { background-position: 0% center; } to { background-position: 200% center; } }
        @keyframes shimmer { 0% { transform: rotate(45deg) translateY(-100%); } 100% { transform: rotate(45deg) translateY(100%); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes pulse-slow { 0%, 100% { opacity: 0.2; transform: scale(1); } 50% { opacity: 0.4; transform: scale(1.1); } }
    </style>
</head>
<body>

    <canvas id="star-canvas"></canvas>

    <div id="app-loader">
        <div class="loader-orbit"></div>
        <div class="loader-text">INFINITY ULTRA</div>
        <div style="margin-top:10px; font-size:10px; color:#555; letter-spacing:3px; font-weight:700;">SYSTEM INITIALIZATION</div>
    </div>

    <header class="header">
        <div class="brand"><i class="fas fa-meteor"></i> CONCEPT SPACE</div>
        <div class="status-badge"><div class="status-dot"></div> ONLINE</div>
    </header>

    <div class="content-area" id="main-scroll">
        
        <div id="view-home" class="view-section">
            <div class="search-wrapper">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="search-input" placeholder="Поиск в космосе...">
                </div>
            </div>

            <div class="promo-slider" id="promo-container"></div>
            <div class="cat-list" id="cat-container"></div>
            <div class="grid" id="prod-grid"></div>
        </div>

        <div id="view-fav" class="view-section" style="display:none; padding-top:20px;">
            <h2 style="padding:0 20px 20px; font-size:26px; font-weight:900; display:flex; align-items:center; gap:12px; letter-spacing:-1px;">
                WISHLIST <i class="fas fa-heart" style="color:var(--accent-red); font-size:22px; filter:drop-shadow(0 0 10px var(--accent-red))"></i>
            </h2>
            <div class="grid" id="fav-grid"></div>
        </div>
        
        <div id="view-orders" class="view-section" style="display:none; padding:20px;">
             <h2 style="padding-bottom:20px; font-size:24px; font-weight:800; display:flex; align-items:center; gap:10px;">
                История <i class="fas fa-history" style="color:var(--accent-gold);"></i>
            </h2>
            <div id="orders-list"></div>
        </div>

        <div id="view-profile" class="view-section" style="display:none; padding:20px;">
            
            <div class="profile-header">
                <div class="profile-avatar-box">
                    <img id="profile-pic" src="" class="profile-avatar-img" style="display:none;">
                    <i id="profile-icon-default" class="fas fa-user-astronaut profile-icon"></i>
                </div>
                <div style="font-size:10px; color:var(--accent-green); font-weight:800; letter-spacing:2px; margin-bottom:5px;" id="welcome-msg">WELCOME BACK</div>
                <h2 id="profile-name" class="profile-name">GUEST</h2>
                <div class="profile-tag" id="profile-nick">@unknown</div>
                <div class="profile-id" id="profile-id">ID: 000000</div>
            </div>

            <div class="social-block">
                <div class="social-btn main" onclick="window.open('https://t.me/CONCEPTSPACEE')">
                    <i class="fab fa-telegram-plane"></i>
                    <span>КАНАЛ</span>
                </div>
                <div class="social-btn info" onclick="window.open('https://t.me/CONCEPTSPACEinfo')">
                    <i class="fas fa-info-circle"></i>
                    <span>ИНФО</span>
                </div>
            </div>
            
            <div class="menu-list">
                <div class="menu-item" onclick="window.open('https://t.me/Lacky337')">
                    <div class="menu-left"><i class="fas fa-headset"></i> Поддержка</div>
                    <i class="fas fa-chevron-right" style="font-size:12px; color:#444;"></i>
                </div>
                <div class="menu-item" onclick="openStatusManager()">
                    <div class="menu-left"><i class="fas fa-shield-alt"></i> Статус</div>
                    <div id="status-text" style="font-size:10px; color:var(--accent-green); font-weight:800; background:rgba(0,255,157,0.1); padding:4px 8px; border-radius:6px;">CLIENT</div>
                </div>
                <div class="menu-item" onclick="clearCache()">
                    <div class="menu-left"><i class="fas fa-broom"></i> Очистить кэш</div>
                    <i class="fas fa-chevron-right" style="font-size:12px; color:#444;"></i>
                </div>
            </div>

            <div style="text-align:center; margin-top:40px; color:#333; font-size:9px; font-weight:900; letter-spacing:3px;">
                CONCEPT SPACE v4.0 ULTRA
            </div>
        </div>

    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="switchView('home', this)">
            <i class="fas fa-home"></i> <span>Home</span>
        </div>
        <div class="nav-item" onclick="switchView('fav', this)">
            <i class="fas fa-heart"></i> <span>Favs</span>
        </div>
        <div class="nav-item" onclick="openCart()">
            <div class="nav-counter" id="cart-counter">0</div>
            <i class="fas fa-shopping-bag"></i> <span>Cart</span>
        </div>
        <div class="nav-item" onclick="switchView('profile', this)">
            <i class="fas fa-user"></i> <span>Profile</span>
        </div>
    </nav>

    <div class="overlay" id="overlay" onclick="closeAll()"></div>

    <div class="sheet" id="sheet-prod">
        <div class="detail-header">
            <img id="pd-img" class="detail-img">
            <div class="detail-meta">
                <div id="pd-stock" style="font-size:11px; font-weight:800; color:#666; margin-bottom:10px; display:flex; align-items:center; gap:6px;">
                    <span style="width:6px; height:6px; background:#666; border-radius:50%;"></span> STOCK
                </div>
                <h2 id="pd-title" style="font-size:24px; line-height:1.1; margin-bottom:10px; font-weight:800;">Product Name</h2>
                <div id="pd-price" style="font-size:30px; font-weight:900; color:var(--accent-green); text-shadow:0 0 20px var(--accent-green-dim);">0 €</div>
            </div>
        </div>

        <div style="margin-bottom:12px; font-size:11px; font-weight:800; color:#555; text-transform:uppercase; letter-spacing:1px;">Configuration</div>
        <div class="opt-group" id="pd-opts"></div>

        <div style="margin-top:auto; display:flex; gap:15px;">
            <div style="display:flex; align-items:center; background:#1a1a1a; border-radius:18px; padding:0 20px; gap:15px; border:1px solid #333;">
                <i class="fas fa-minus" onclick="modQty(-1)" style="color:#fff; cursor:pointer;"></i>
                <span id="pd-qty" style="font-weight:800; font-size:18px; width:24px; text-align:center;">1</span>
                <i class="fas fa-plus" onclick="modQty(1)" style="color:#fff; cursor:pointer;"></i>
            </div>
            <button class="btn-main" id="btn-add-cart" onclick="addToCart()">
                ADD TO CART <i class="fas fa-cart-plus"></i>
            </button>
        </div>
    </div>

    <div class="sheet" id="sheet-cart" style="height:92vh;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
            <h2 style="font-size:28px; font-weight:900; letter-spacing:-1px;">CART</h2>
            <div onclick="clearCart()" style="color:var(--accent-red); font-size:11px; font-weight:800; cursor:pointer; padding:6px 12px; background:rgba(255, 42, 109, 0.1); border-radius:10px;">CLEAR ALL</div>
        </div>

        <div class="cart-list" id="cart-list"></div>

        <div style="background:#161616; padding:25px; border-radius:24px; border:1px solid #333; position:relative; overflow:hidden; box-shadow: 0 -10px 40px rgba(0,0,0,0.5);">
            <div style="position:absolute; top:0; left:0; width:100%; height:4px; background:linear-gradient(90deg, var(--accent-green), var(--accent-purple));"></div>
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-size:22px; font-weight:800; color:#fff;">
                <span style="color:#666; font-size:16px; font-weight:700;">TOTAL:</span> 
                <span id="cart-total" style="color:var(--accent-green); text-shadow:0 0 15px var(--accent-green-dim);">0 €</span>
            </div>
            <button class="btn-main" onclick="checkout()">
                CHECKOUT <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <div class="sheet" id="sheet-status">
        <div style="text-align:center; margin-bottom:25px;">
            <i class="fas fa-shield-alt" style="font-size:48px; color:var(--accent-green); margin-bottom:15px; filter:drop-shadow(0 0 20px var(--accent-green))"></i>
            <h2 style="font-size:24px; font-weight:900;">YOUR STATUS</h2>
        </div>
        
        <div style="background:#161616; padding:25px; border-radius:24px; border:1px solid #333; margin-bottom:25px; box-shadow: inset 0 0 30px rgba(0,0,0,0.5);">
            <div style="display:flex; justify-content:space-between; font-weight:800; font-size:14px; letter-spacing:1px;">
                <span>CLIENT</span>
                <span style="color:var(--accent-green); text-shadow:0 0 10px var(--accent-green);">VIP</span>
            </div>
            <div class="status-level-bar">
                <div class="status-progress" style="width:30%"></div>
            </div>
            <div style="font-size:10px; color:#666; margin-top:8px; text-align:right;">3 Orders left to Level Up</div>
        </div>

        <h3 style="font-size:14px; margin-bottom:15px; color:#fff; font-weight:800; text-transform:uppercase;">Privileges</h3>
        <div class="privilege-item"><i class="fas fa-check"></i> Catalog Access</div>
        <div class="privilege-item"><i class="fas fa-check"></i> Priority Support</div>
        <div class="privilege-item" style="color:#555"><i class="fas fa-lock"></i> Personal Manager (VIP)</div>
        <div class="privilege-item" style="color:#555"><i class="fas fa-lock"></i> Discount 10% (VIP)</div>

        <button class="btn-main" id="btn-admin-login" onclick="openAuth()" style="margin-top:auto; background:#222; color:#fff; border:1px solid #333; box-shadow:none;">
            STAFF LOGIN <i class="fas fa-key"></i>
        </button>
    </div>

    <div class="admin-float-btn" id="admin-float-btn" onclick="openAuth()" style="display:none;"><i class="fas fa-fingerprint"></i></div>

    <div class="admin-panel" id="admin-panel">
        <div class="adm-nav">
            <div style="font-weight:900; font-size:18px; color:var(--accent-green); display:flex; align-items:center; gap:10px; text-shadow:0 0 10px var(--accent-green-dim);">
                <i class="fas fa-terminal"></i> CS:ADMIN
            </div>
            <i class="fas fa-times" onclick="toggleAdmin(false)" style="font-size:24px; padding:5px; color:#666;"></i>
        </div>
        <div class="adm-tabs">
            <div class="adm-tab active" onclick="setTab('dash')">DASHBOARD</div>
            <div class="adm-tab" onclick="setTab('prod')">PRODUCTS</div>
            <div class="adm-tab" onclick="setTab('promo')">PROMO</div>
            <div class="adm-tab" onclick="setTab('cats')">CATS</div>
            <div class="adm-tab" onclick="setTab('users')" style="color:var(--accent-gold)">USERS</div>
        </div>

        <div class="adm-content" id="adm-content">
            <div id="tab-dash">
                <div class="adm-card">
                    <div style="font-weight:bold; margin-bottom:15px; color:#fff;">Sales Stats (Week)</div>
                    <div class="chart-bar-container">
                        <div class="chart-col" style="height:40%" title="Mon"></div>
                        <div class="chart-col" style="height:60%" title="Tue"></div>
                        <div class="chart-col" style="height:30%" title="Wed"></div>
                        <div class="chart-col" style="height:80%; background:var(--accent-purple); box-shadow:0 0 10px var(--accent-purple);" title="Thu"></div>
                        <div class="chart-col" style="height:50%" title="Fri"></div>
                        <div class="chart-col" style="height:90%; background:var(--accent-green); box-shadow:0 0 15px var(--accent-green);" title="Sat"></div>
                        <div class="chart-col" style="height:70%" title="Sun"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:15px;">
                        <div style="text-align:center;">
                            <div style="font-size:10px; color:#666;">ORDERS</div>
                            <div style="font-size:18px; font-weight:900; color:#fff;">142</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:10px; color:#666;">REVENUE</div>
                            <div style="font-size:18px; font-weight:900; color:var(--accent-green);">4.2k €</div>
                        </div>
                         <div style="text-align:center;">
                            <div style="font-size:10px; color:#666;">VIEWS</div>
                            <div style="font-size:18px; font-weight:900; color:var(--accent-blue);">8.5k</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-prod" style="display:none;">
                <div class="adm-card">
                    <div style="font-weight:bold; margin-bottom:15px; display:flex; justify-content:space-between; color:#fff;">
                        <span>Product Editor</span>
                        <span onclick="resetForm()" style="color:var(--accent-red); font-size:10px; cursor:pointer;">RESET</span>
                    </div>
                    <input id="nf-name" class="adm-input" placeholder="Product Name">
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="nf-price" class="adm-input" placeholder="Price">
                        <input type="number" id="nf-stock" class="adm-input" placeholder="Stock">
                    </div>
                    <select id="nf-cat" class="adm-input" style="color:#aaa"></select>
                    <input id="nf-opts" class="adm-input" placeholder="Options (comma separated)">
                    <input id="nf-img" class="adm-input" placeholder="Image URL..." onchange="updPreview(this.value, 'prev-prod')">
                    
                    <label class="adm-file-label">
                        <i class="fas fa-camera"></i> Upload Photo (Max 150KB)
                        <input type="file" accept="image/*" style="display:none" onchange="handleUpload(this, 'nf-img', 'prev-prod')">
                    </label>
                    <img id="prev-prod" style="width:100%; height:150px; object-fit:cover; border-radius:12px; margin-bottom:15px; display:none; border:1px solid #333;">

                    <button class="btn-main" onclick="saveProduct()" style="height:50px;">SAVE PRODUCT <i class="fas fa-save"></i></button>
                </div>
                <div id="adm-prod-list"></div>
            </div>

            <div id="tab-promo" style="display:none;">
                <div class="adm-card">
                    <div style="font-weight:bold; margin-bottom:15px; color:#fff;">New Banner</div>
                    <input id="bf-title" class="adm-input" placeholder="Title (SUMMER DROP)">
                    <div style="display:flex; gap:10px;">
                        <input id="bf-badge" class="adm-input" placeholder="Badge (NEW)">
                        <select id="bf-color" class="adm-input">
                            <option value="#00ff9d">Green</option>
                            <option value="#9d00ff">Purple</option>
                            <option value="#ff2a6d">Red</option>
                            <option value="#00ccff">Blue</option>
                        </select>
                    </div>
                    <input id="bf-img" class="adm-input" placeholder="Banner URL..." onchange="updPreview(this.value, 'prev-ban')">
                    
                    <label class="adm-file-label">
                        <i class="fas fa-image"></i> Upload Banner
                        <input type="file" accept="image/*" style="display:none" onchange="handleUpload(this, 'bf-img', 'prev-ban')">
                    </label>
                    <img id="prev-ban" style="width:100%; height:100px; object-fit:cover; border-radius:12px; margin-bottom:15px; display:none;">

                    <button class="btn-main" onclick="saveBanner()" style="height:50px;">ADD BANNER</button>
                </div>
                <div style="font-size:10px; font-weight:bold; color:#666; margin-bottom:10px; padding-left:5px;">ACTIVE BANNERS</div>
                <div id="adm-ban-list"></div>
            </div>

            <div id="tab-cats" style="display:none;">
                <div class="adm-card">
                    <input id="cf-id" class="adm-input" placeholder="ID (vape, pod...)">
                    <input id="cf-name" class="adm-input" placeholder="Name (Vapes)">
                    <button class="btn-main" onclick="saveCat()" style="height:50px;">CREATE CATEGORY</button>
                </div>
                <div id="adm-cat-list"></div>
            </div>

            <div id="tab-users" style="display:none;">
                <div class="adm-card" style="border-color: var(--accent-gold); box-shadow:0 0 15px rgba(255, 215, 0, 0.05);">
                    <div style="font-weight:bold; margin-bottom:15px; color:var(--accent-gold);">Role Management</div>
                    <input id="uf-id" class="adm-input" placeholder="Telegram ID (numbers)">
                    <select id="uf-role" class="adm-input">
                        <option value="admin">ADMIN (Full Access)</option>
                        <option value="manager">MANAGER (Products)</option>
                        <option value="vip">VIP (Status Only)</option>
                    </select>
                    <button class="btn-main" onclick="saveUserRole()" style="height:50px; background:var(--accent-gold); color:#000;">GRANT ROLE</button>
                </div>
                <div style="font-size:10px; font-weight:bold; color:#666; margin-bottom:10px; padding-left:5px;">STAFF & VIPs</div>
                <div id="adm-users-list"></div>
            </div>

        </div>
    </div>

    <div id="auth-modal" style="position:fixed; inset:0; background:#000; z-index:1000; display:none; flex-direction:column; align-items:center; justify-content:center;">
        <i class="fas fa-shield-alt" style="font-size:70px; color:#222; margin-bottom:30px; animation:pulse 2s infinite; filter:drop-shadow(0 0 20px #222)"></i>
        <div style="font-size:12px; letter-spacing:6px; color:#555; margin-bottom:20px; font-weight:900;">SECURITY PROTOCOL</div>
        <input type="password" id="auth-pin" class="adm-input" style="width:220px; text-align:center; font-size:24px; letter-spacing:8px; background:#111; border-color:#333;" placeholder="••••" maxlength="20">
        <div style="display:flex; gap:15px; margin-top:30px;">
            <button class="btn-main" onclick="checkAuth()" style="width:160px;">ACCESS</button>
            <button class="btn-main" onclick="closeAuth()" style="width:80px; background:#222; box-shadow:none;">ESC</button>
        </div>
    </div>

    <div id="toast"><i class="fas fa-check-circle"></i> <span id="toast-msg">Success</span></div>

    <script>
        // =================================================================
        // CONFIG & STATE
        // =================================================================
        const CFG = {
            BIN_ID: "696e703dae596e708fe71325",
            API_KEY: "$2a$10$KhVEyfwrswNvk7dNQEJWPezsQABoaOnmNm/jtb8vqYWBJrL8eciFm",
            ADMIN_PIN: "2708",
            TG_OWNER: "Lacky337",
            OWNER_ID: 1017573139
        };

        // GLOBAL STATE
        let STATE = {
            products: [],
            categories: [
                {id: 'all', name: 'All'},
                {id: 'pod', name: 'Pods'},
                {id: 'liquid', name: 'Liquids'}
            ],
            banners: [
                {id: 1, title: 'WELCOME TO SPACE', badge: 'NEW', color: '#00ff9d', img: 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?auto=format&fit=crop&w=1000&q=80'}
            ],
            users: {
                "1017573139": "admin"
            } 
        };

        let USER = { cart: [], favs: [], orders: [] }; 
        let UI = { activeCat: 'all', curProd: null, editId: null, role: 'client' };
        const tg = window.Telegram.WebApp;

        // =================================================================
        // INITIALIZATION
        // =================================================================
        window.onload = async () => {
            tg.ready(); tg.expand();
            
            // Set App Colors
            tg.setHeaderColor('#050505');
            tg.setBackgroundColor('#050505');

            initStars();
            
            // Load Local User Data
            try {
                const local = localStorage.getItem('cs_user_v4_ultra');
                if(local) {
                    USER = JSON.parse(local);
                    if(!USER.cart) USER.cart = [];
                    if(!USER.favs) USER.favs = [];
                    if(!USER.orders) USER.orders = [];
                }
            } catch(e) {
                console.error("Cache corrupted, resetting user", e);
                USER = { cart: [], favs: [], orders: [] };
            }
            
            // Sync with Cloud
            await cloudLoad();
            
            // Init Profile & Check Roles
            initProfile();

            // Render UI
            renderAll();
            renderOrders(); // Keeps logic running even if hidden
            
            // Hide Loader
            setTimeout(() => {
                const l = document.getElementById('app-loader');
                l.style.opacity = '0';
                setTimeout(() => l.style.display = 'none', 600);
            }, 1200); // Slightly longer for dramatic effect

            // Listeners
            document.getElementById('search-input').addEventListener('input', (e) => renderGrid(e.target.value));
            
            // COSMIC CLICK EFFECT
            window.addEventListener('click', (e) => {
                const p = document.createElement('div');
                p.className = 'click-particle';
                p.style.left = e.clientX + 'px';
                p.style.top = e.clientY + 'px';
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 1000);
            });
        };

        function initProfile() {
            const u = tg.initDataUnsafe?.user;
            
            // Welcome Message Time Logic
            const hr = new Date().getHours();
            let msg = "WELCOME BACK";
            if(hr >= 5 && hr < 12) msg = "GOOD MORNING";
            else if(hr >= 12 && hr < 18) msg = "GOOD AFTERNOON";
            else if(hr >= 18 && hr < 22) msg = "GOOD EVENING";
            else msg = "GOOD NIGHT";
            document.getElementById('welcome-msg').innerText = msg;

            if (u) {
                // Name
                document.getElementById('profile-name').innerText = (u.first_name + ' ' + (u.last_name || '')).toUpperCase();
                
                // Username
                const nickEl = document.getElementById('profile-nick');
                const nick = u.username ? '@' + u.username : 'GUEST';
                nickEl.innerHTML = nick;
                
                // ID
                document.getElementById('profile-id').innerText = `ID: ${u.id}`;
                
                // Photo
                if (u.photo_url) {
                    const img = document.getElementById('profile-pic');
                    img.src = u.photo_url;
                    img.style.display = 'block';
                    document.getElementById('profile-icon-default').style.display = 'none';
                }

                // ROLES
                if (u.id === CFG.OWNER_ID) {
                    UI.role = 'admin';
                } else if(STATE.users && STATE.users[u.id]) {
                    UI.role = STATE.users[u.id];
                }
            }

            // Apply Role to UI
            const st = document.getElementById('status-text');
            const nickEl = document.getElementById('profile-nick');
            
            if(UI.role === 'admin') {
                st.innerText = "ADMINISTRATOR";
                st.style.color = 'var(--accent-gold)';
                st.style.background = 'rgba(255, 215, 0, 0.1)';
                document.getElementById('admin-float-btn').style.display = 'flex';
                nickEl.innerHTML += ' <i class="fas fa-star" style="color:var(--accent-gold); font-size:12px; margin-left:4px;" title="Admin"></i>';
            } 
            else if(UI.role === 'manager') {
                st.innerText = "MANAGER";
                st.style.color = 'var(--accent-blue)';
                st.style.background = 'rgba(0, 240, 255, 0.1)';
                document.getElementById('admin-float-btn').style.display = 'flex';
                nickEl.innerHTML += ' <i class="fas fa-check-circle" style="color:var(--accent-blue); font-size:12px; margin-left:4px;" title="Manager"></i>';
            }
            else if(UI.role === 'vip') {
                st.innerText = "VIP CLIENT";
                st.style.color = 'var(--accent-purple)';
                st.style.background = 'rgba(188, 19, 254, 0.1)';
                nickEl.innerHTML += ' <i class="fas fa-gem" style="color:var(--accent-purple); font-size:12px; margin-left:4px;" title="VIP"></i>';
            }
        }

        // =================================================================
        // CLOUD SYNC ENGINE
        // =================================================================
        async function cloudLoad() {
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': CFG.API_KEY }
                });
                if(res.ok) {
                    const json = await res.json();
                    const data = json.record;
                    if(data.products) STATE.products = data.products;
                    if(data.categories) STATE.categories = data.categories;
                    if(data.banners) STATE.banners = data.banners;
                    if(data.users) STATE.users = data.users || {};
                    STATE.users[CFG.OWNER_ID] = "admin";
                }
            } catch(e) { console.error("Offline"); showToast("Offline Mode Active", true); }
        }

        async function cloudSave() {
            showToast("Syncing with Space...");
            try {
                const resCheck = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': CFG.API_KEY }
                });
                const jsonCheck = await resCheck.json();
                let serverData = jsonCheck.record;

                serverData.products = STATE.products;
                serverData.categories = STATE.categories;
                serverData.banners = STATE.banners;
                serverData.users = STATE.users;
                if(!serverData.users) serverData.users = {};
                serverData.users[CFG.OWNER_ID] = "admin";

                await fetch(`https://api.jsonbin.io/v3/b/${CFG.BIN_ID}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': CFG.API_KEY },
                    body: JSON.stringify(serverData)
                });
                showToast("Data Saved Successfully!");
            } catch(e) { showToast("Save Error", true); console.error(e); }
        }

        // =================================================================
        // RENDERING
        // =================================================================
        function renderAll() {
            renderBanners();
            renderCats();
            renderGrid();
            updateCartBadge();
        }

        function renderBanners() {
            const c = document.getElementById('promo-container');
            c.innerHTML = '';
            if(!STATE.banners.length) return;
            
            STATE.banners.forEach(b => {
                c.innerHTML += `
                <div class="promo-slide">
                    <img src="${b.img}" class="promo-img">
                    <div class="promo-overlay">
                        <span class="promo-tag" style="background:${b.color}">${b.badge}</span>
                        <div class="promo-title">${b.title}</div>
                    </div>
                </div>`;
            });
        }

        function renderCats() {
            const c = document.getElementById('cat-container');
            const sel = document.getElementById('nf-cat');
            c.innerHTML = ''; sel.innerHTML = '';
            
            STATE.categories.forEach(cat => {
                const el = document.createElement('div');
                el.className = `cat-item ${UI.activeCat === cat.id ? 'active' : ''}`;
                el.innerText = cat.name;
                el.onclick = () => {
                    UI.activeCat = cat.id;
                    renderCats(); renderGrid();
                    tg.HapticFeedback.selectionChanged();
                };
                c.appendChild(el);

                if(cat.id !== 'all') sel.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
            });
        }

        function renderGrid(query = '') {
            const grid = document.getElementById('prod-grid');
            grid.innerHTML = '';
            const q = query.toLowerCase();

            const items = STATE.products.filter(p => {
                const matchCat = UI.activeCat === 'all' || p.cat === UI.activeCat;
                const matchName = p.name.toLowerCase().includes(q);
                return matchCat && matchName;
            });

            if(!items.length) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#555; font-size:12px; letter-spacing:1px;">NOTHING FOUND IN SPACE...</div>';
                return;
            }

            items.forEach(p => {
                const isFav = USER.favs.includes(p.id);
                grid.innerHTML += `
                <div class="card" onclick="openProd(${p.id})">
                    <div class="card-top">
                        <img src="${p.img}" class="card-img" loading="lazy">
                        <div class="card-status">
                            ${p.stock < 1 ? '<span class="badge hot">SOLD OUT</span>' : ''}
                            ${p.stock > 0 && p.stock < 5 ? '<span class="badge sale">LOW STOCK</span>' : ''}
                        </div>
                        <div class="fav-btn ${isFav?'active':''}" onclick="event.stopPropagation(); toggleFav(${p.id})">
                            <i class="${isFav?'fas':'far'} fa-heart"></i>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="card-title">${p.name}</div>
                        <div class="card-price-row">
                            <div class="price">${p.price} €</div>
                            <div class="add-icon"><i class="fas fa-plus"></i></div>
                        </div>
                    </div>
                </div>`;
            });
        }

        function renderFavs() {
            const grid = document.getElementById('fav-grid');
            grid.innerHTML = '';
            const items = STATE.products.filter(p => USER.favs.includes(p.id));
            
            if(!items.length) { grid.innerHTML = '<div style="color:#555; text-align:center; padding:30px; grid-column:1/-1;">Your wishlist is empty.</div>'; return; }

            items.forEach(p => {
                grid.innerHTML += `
                <div class="card" onclick="openProd(${p.id})">
                    <div class="card-top">
                        <img src="${p.img}" class="card-img">
                        <div class="fav-btn active" onclick="event.stopPropagation(); toggleFav(${p.id})"><i class="fas fa-heart"></i></div>
                    </div>
                    <div class="card-body">
                        <div class="card-title">${p.name}</div>
                        <div class="price">${p.price} €</div>
                    </div>
                </div>`;
            });
        }

        // =================================================================
        // PRODUCT LOGIC
        // =================================================================
        function openProd(id) {
            UI.curProd = STATE.products.find(x => x.id === id);
            if(!UI.curProd) return;

            document.getElementById('pd-img').src = UI.curProd.img;
            document.getElementById('pd-title').innerText = UI.curProd.name;
            document.getElementById('pd-price').innerText = UI.curProd.price + " €";
            
            const stock = document.getElementById('pd-stock');
            const btn = document.getElementById('btn-add-cart');
            
            if(UI.curProd.stock < 1) {
                stock.innerHTML = "<span style='color:var(--accent-red)'>SOLD OUT</span>";
                btn.style.opacity = 0.5; btn.style.pointerEvents = "none"; btn.innerText = "OUT OF STOCK";
            } else {
                stock.innerHTML = `<span style="width:6px; height:6px; background:var(--accent-green); border-radius:50%; box-shadow:0 0 5px var(--accent-green)"></span> IN STOCK: ${UI.curProd.stock}`;
                btn.style.opacity = 1; btn.style.pointerEvents = "all"; btn.innerHTML = 'ADD TO CART <i class="fas fa-cart-plus"></i>';
            }

            // Options
            const optsBox = document.getElementById('pd-opts');
            optsBox.innerHTML = '';
            const opts = UI.curProd.opts && UI.curProd.opts.length ? UI.curProd.opts : ['Standard'];
            UI.curProd._selOpt = opts[0];
            UI.curProd._qty = 1;

            opts.forEach(o => {
                const ch = document.createElement('div');
                ch.className = `opt-chip ${o === opts[0] ? 'selected' : ''}`;
                ch.innerText = o;
                ch.onclick = () => {
                    UI.curProd._selOpt = o;
                    document.querySelectorAll('.opt-chip').forEach(x => x.classList.remove('selected'));
                    ch.classList.add('selected');
                };
                optsBox.appendChild(ch);
            });

            document.getElementById('pd-qty').innerText = 1;
            openSheet('sheet-prod');
        }

        function modQty(d) {
            const current = parseInt(UI.curProd._qty) || 1;
            const newQ = current + d;
            
            if(newQ < 1) return;
            if(newQ > UI.curProd.stock) return showToast("Max Stock Reached", true);
            
            UI.curProd._qty = newQ;
            document.getElementById('pd-qty').innerText = newQ;
            document.getElementById('pd-price').innerText = (UI.curProd.price * newQ).toFixed(2) + " €";
        }

        function addToCart() {
            const finalQty = parseInt(UI.curProd._qty);
            if(isNaN(finalQty) || finalQty < 1) return showToast("Qty Error", true);

            const item = {
                id: UI.curProd.id,
                name: UI.curProd.name,
                price: parseFloat(UI.curProd.price),
                img: UI.curProd.img,
                opt: UI.curProd._selOpt,
                q: finalQty
            };
            
            const exist = USER.cart.find(x => x.id === item.id && x.opt === item.opt);
            if(exist) {
                exist.q += item.q;
            } else {
                USER.cart.push(item);
            }
            
            saveUser();
            closeAll();
            showToast("Added to Cart");
            tg.HapticFeedback.notificationOccurred('success');
        }

        function toggleFav(id) {
            if(USER.favs.includes(id)) USER.favs = USER.favs.filter(x=>x!==id);
            else USER.favs.push(id);
            saveUser();
            renderGrid();
            if(document.getElementById('view-fav').style.display === 'block') renderFavs();
            tg.HapticFeedback.impactOccurred('light');
        }

        // =================================================================
        // CART & ORDERS
        // =================================================================
        function openCart() {
            const l = document.getElementById('cart-list');
            l.innerHTML = '';
            let total = 0;

            if(!USER.cart.length) l.innerHTML = '<div style="text-align:center; padding:40px; color:#555; font-size:12px;">Cart is empty like a black hole...</div>';
            
            USER.cart.forEach((item, i) => {
                const itemTotal = item.price * item.q;
                total += itemTotal;
                l.innerHTML += `
                <div class="cart-item">
                    <img src="${item.img}" style="width:64px; height:64px; border-radius:14px; object-fit:cover;">
                    <div style="flex:1">
                        <div style="font-weight:bold; font-size:14px; margin-bottom:5px;">${item.name}</div>
                        <div style="font-size:11px; color:#aaa; background:rgba(255,255,255,0.05); display:inline-block; padding:3px 8px; border-radius:6px;">${item.opt}</div>
                        <div style="color:var(--accent-green); font-size:14px; font-weight:800; margin-top:5px;">${itemTotal.toFixed(2)} €</div>
                    </div>
                    <div style="font-weight:900; font-size:15px; margin-right:12px;">x${item.q}</div>
                    <i class="fas fa-trash" style="color:#555; padding:10px; cursor:pointer;" onclick="delCart(${i})"></i>
                </div>`;
            });

            document.getElementById('cart-total').innerText = total.toFixed(2) + " €";
            openSheet('sheet-cart');
        }

        function delCart(i) { USER.cart.splice(i, 1); saveUser(); openCart(); }
        function clearCart() { USER.cart = []; saveUser(); openCart(); }

        function checkout() {
            if(!USER.cart.length) return;
            
            const total = USER.cart.reduce((a,b) => a + (b.price*b.q), 0).toFixed(2);
            const order = {
                id: Date.now().toString().slice(-6),
                date: new Date().toLocaleDateString(),
                items: [...USER.cart], 
                total: total
            };
            USER.orders.unshift(order);
            
            let m = `🚀 *NEW ORDER #${order.id} | CONCEPT SPACE*\n\n`;
            USER.cart.forEach(x => m += `▪️ ${x.name} (${x.opt}) x${x.q} = ${(x.price*x.q).toFixed(2)}€\n`);
            m += `\n💰 *TOTAL: ${total}€*`;
            m += `\n👤 User: @${tg.initDataUnsafe?.user?.username || 'Guest'} (ID: ${tg.initDataUnsafe?.user?.id || '?'})`;
            
            USER.cart = [];
            saveUser();
            renderOrders(); // Update hidden history
            
            window.open(`https://t.me/${CFG.TG_OWNER}?text=${encodeURIComponent(m)}`);
            tg.close();
        }

        function renderOrders() {
            const c = document.getElementById('orders-list');
            c.innerHTML = '';
            if(!USER.orders.length) {
                c.innerHTML = '<div style="color:#555; text-align:center; margin-top:30px;">History is empty</div>';
                return;
            }
            USER.orders.forEach(o => {
                let itemsHtml = '';
                o.items.forEach(i => itemsHtml += `<div class="order-info">▪ ${i.name} x${i.q}</div>`);
                c.innerHTML += `
                <div style="background:#111; border:1px solid #222; border-radius:16px; padding:15px; margin-bottom:15px;">
                    <div style="display:flex; justify-content:space-between; font-size:12px; color:#666; margin-bottom:10px; border-bottom:1px solid #222; padding-bottom:8px;">
                        <span>#${o.id} | ${o.date}</span>
                        <span style="color:var(--accent-green)">${o.total} €</span>
                    </div>
                    ${itemsHtml}
                    <div style="text-align:right; font-size:10px; color:#555; margin-top:5px; text-transform:uppercase;">Completed</div>
                </div>`;
            });
        }

        // =================================================================
        // ADMIN & AUTH
        // =================================================================
        function openStatusManager() {
            openSheet('sheet-status');
        }

        function openAuth() { 
            closeAll();
            document.getElementById('auth-modal').style.display = 'flex'; 
        }
        function closeAuth() { document.getElementById('auth-modal').style.display = 'none'; }
        
        function checkAuth() {
            if(UI.role === 'admin' || UI.role === 'manager') {
                grantAdminAccess();
                return;
            }
            if(document.getElementById('auth-pin').value === CFG.ADMIN_PIN) {
                grantAdminAccess();
            } else {
                showToast("Invalid PIN", true);
                tg.HapticFeedback.notificationOccurred('error');
            }
        }
        
        function grantAdminAccess() {
            closeAuth();
            toggleAdmin(true);
            renderAdmList();
            renderAdmPromo();
            renderAdmCats();
            renderAdmUsers();
            if(UI.role === 'manager') {
                document.querySelector('[onclick="setTab(\'users\')"]').style.display = 'none';
            }
        }

        function toggleAdmin(o) {
            const p = document.getElementById('admin-panel');
            o ? p.classList.add('open') : p.classList.remove('open');
        }

        function setTab(t) {
            document.querySelectorAll('.adm-tab').forEach(x=>x.classList.remove('active'));
            event.target.classList.add('active');
            ['dash','prod','promo','cats','users'].forEach(id => {
                const el = document.getElementById('tab-'+id);
                if(el) el.style.display='none';
            });
            document.getElementById('tab-'+t).style.display='block';
        }

        // --- ADMIN HELPERS ---
        function renderAdmList() {
            const l = document.getElementById('adm-prod-list');
            l.innerHTML = '';
            STATE.products.forEach(p => {
                l.innerHTML += `
                <div style="background:#1a1a1a; padding:10px; border-radius:12px; margin-bottom:10px; display:flex; align-items:center; gap:12px; border:1px solid #333;">
                    <img src="${p.img}" style="width:50px; height:50px; border-radius:8px; object-fit:cover;">
                    <div style="flex:1; font-size:12px;"><b>${p.name}</b><br><span style="color:#666">Stock: ${p.stock}</span></div>
                    <i class="fas fa-pen" style="color:#888; padding:10px; cursor:pointer;" onclick="editProd(${p.id})"></i>
                    <i class="fas fa-trash" style="color:var(--accent-red); padding:10px; cursor:pointer;" onclick="delProd(${p.id})"></i>
                </div>`;
            });
        }
        async function saveProduct() {
            const name = document.getElementById('nf-name').value;
            const price = parseFloat(document.getElementById('nf-price').value);
            const stock = parseInt(document.getElementById('nf-stock').value);
            const cat = document.getElementById('nf-cat').value;
            const img = document.getElementById('nf-img').value;
            const opts = document.getElementById('nf-opts').value.split(',').map(x=>x.trim()).filter(Boolean);

            if(!name || !price) return showToast("Fill fields!", true);

            const item = { id: UI.editId || Date.now(), name, price, stock, cat, img, opts };
            
            if(UI.editId) {
                const idx = STATE.products.findIndex(x => x.id === UI.editId);
                STATE.products[idx] = item;
            } else {
                STATE.products.unshift(item);
            }
            
            await cloudSave();
            renderAdmList(); renderGrid(); resetForm();
        }
        function editProd(id) {
            const p = STATE.products.find(x => x.id === id);
            UI.editId = id;
            document.getElementById('nf-name').value = p.name;
            document.getElementById('nf-price').value = p.price;
            document.getElementById('nf-stock').value = p.stock;
            document.getElementById('nf-cat').value = p.cat;
            document.getElementById('nf-img').value = p.img;
            document.getElementById('nf-opts').value = p.opts ? p.opts.join(', ') : '';
            updPreview(p.img, 'prev-prod');
            document.getElementById('tab-prod').scrollIntoView();
        }
        function delProd(id) {
            if(confirm("Delete product?")) {
                STATE.products = STATE.products.filter(x => x.id !== id);
                cloudSave(); renderAdmList(); renderGrid();
            }
        }
        function resetForm() {
            UI.editId = null;
            document.querySelectorAll('#tab-prod input').forEach(i => i.value = '');
            document.getElementById('prev-prod').style.display='none';
        }

        function renderAdmPromo() {
            const l = document.getElementById('adm-ban-list');
            l.innerHTML = '';
            STATE.banners.forEach((b, idx) => {
                l.innerHTML += `
                <div style="background:#1a1a1a; padding:10px; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid #333;">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <img src="${b.img}" style="width:60px; height:35px; object-fit:cover; border-radius:6px;">
                        <div style="font-size:11px;"><b>${b.title}</b><br><span style="color:${b.color}">${b.badge}</span></div>
                    </div>
                    <i class="fas fa-trash" style="color:var(--accent-red); cursor:pointer; padding:5px;" onclick="delBan(${idx})"></i>
                </div>`;
            });
        }
        async function saveBanner() {
            const title = document.getElementById('bf-title').value;
            const badge = document.getElementById('bf-badge').value;
            const color = document.getElementById('bf-color').value;
            const img = document.getElementById('bf-img').value;

            if(!img) return showToast("Image required", true);

            STATE.banners.push({ id: Date.now(), title, badge, color, img });
            await cloudSave();
            renderAdmPromo(); renderBanners();
            document.getElementById('bf-title').value='';
            document.getElementById('bf-img').value='';
        }
        function delBan(idx) {
            if(confirm("Remove banner?")) {
                STATE.banners.splice(idx, 1);
                cloudSave(); renderAdmPromo(); renderBanners();
            }
        }

        function renderAdmCats() {
            const l = document.getElementById('adm-cat-list');
            l.innerHTML = '';
            STATE.categories.forEach(c => {
                if(c.id !== 'all') l.innerHTML += `
                <div style="background:#1a1a1a; padding:12px; border-radius:10px; margin-bottom:6px; display:flex; justify-content:space-between; border:1px solid #333;">
                    <span style="font-size:12px; font-weight:bold;">${c.name} <span style="color:#666">(${c.id})</span></span>
                    <i class="fas fa-trash" style="color:var(--accent-red); cursor:pointer;" onclick="delCat('${c.id}')"></i>
                </div>`;
            });
        }
        async function saveCat() {
            const id = document.getElementById('cf-id').value;
            const name = document.getElementById('cf-name').value;
            if(!id) return;
            STATE.categories.push({ id, name });
            await cloudSave(); renderAdmCats(); renderCats();
            document.getElementById('cf-id').value = ''; document.getElementById('cf-name').value = '';
        }
        function delCat(id) {
            if(confirm("Delete category?")) {
                STATE.categories = STATE.categories.filter(c => c.id !== id);
                cloudSave(); renderAdmCats(); renderCats();
            }
        }

        function renderAdmUsers() {
            const l = document.getElementById('adm-users-list');
            l.innerHTML = '';
            const users = STATE.users || {};
            for(const [id, role] of Object.entries(users)) {
                let color = '#fff';
                let icon = 'fa-user';
                if(role === 'admin') { color = 'var(--accent-gold)'; icon = 'fa-star'; }
                if(role === 'manager') { color = 'var(--accent-blue)'; icon = 'fa-check-circle'; }
                if(role === 'vip') { color = 'var(--accent-purple)'; icon = 'fa-gem'; }

                l.innerHTML += `
                <div style="background:#1a1a1a; padding:12px; border-radius:10px; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; border:1px solid #333;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <i class="fas ${icon}" style="color:${color}; font-size:16px;"></i>
                        <div>
                            <div style="font-size:12px; font-weight:bold;">ID: ${id}</div>
                            <div style="font-size:10px; color:${color}; letter-spacing:1px; font-weight:800;">${role.toUpperCase()}</div>
                        </div>
                    </div>
                    <i class="fas fa-trash" style="color:var(--accent-red); cursor:pointer; padding:5px;" onclick="removeRole('${id}')"></i>
                </div>`;
            }
        }
        async function saveUserRole() {
            const id = document.getElementById('uf-id').value;
            const role = document.getElementById('uf-role').value;
            if(!id) return showToast("ID Required", true);
            
            if(!STATE.users) STATE.users = {};
            STATE.users[id] = role;
            
            await cloudSave();
            renderAdmUsers();
            document.getElementById('uf-id').value = '';
            showToast("Role Granted");
        }
        async function removeRole(id) {
            if(id == CFG.OWNER_ID) return showToast("Can't remove Owner!", true);
            if(confirm("Revoke rights?")) {
                delete STATE.users[id];
                await cloudSave();
                renderAdmUsers();
            }
        }

        // =================================================================
        // HELPERS
        // =================================================================
        function handleUpload(input, targetId, prevId) {
            const f = input.files[0];
            if(!f) return;
            if(f.size > 150000) return alert("File too big (Max 150KB)! Use URL instead.");
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById(targetId).value = e.target.result;
                updPreview(e.target.result, prevId);
            };
            reader.readAsDataURL(f);
        }
        function updPreview(src, id) {
            const el = document.getElementById(id);
            if(src) { el.src = src; el.style.display = 'block'; } else el.style.display = 'none';
        }

        function switchView(view, el) {
            document.querySelectorAll('.view-section').forEach(x => x.style.display = 'none');
            document.getElementById('view-' + view).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            if(el) el.classList.add('active');
            
            if(view === 'fav') renderFavs();
            document.getElementById('main-scroll').scrollTo({top:0});
            tg.HapticFeedback.selectionChanged();
        }

        function openSheet(id) {
            document.getElementById('overlay').classList.add('show');
            document.getElementById(id).classList.add('show');
            tg.HapticFeedback.impactOccurred('medium');
        }
        function closeAll() {
            document.getElementById('overlay').classList.remove('show');
            document.querySelectorAll('.sheet').forEach(x => x.classList.remove('show'));
        }

        function saveUser() {
            localStorage.setItem('cs_user_v4_ultra', JSON.stringify(USER));
            updateCartBadge();
        }
        function updateCartBadge() {
            const c = USER.cart.reduce((a,b) => a+b.q, 0);
            const el = document.getElementById('cart-counter');
            el.innerText = c;
            c > 0 ? el.classList.add('visible') : el.classList.remove('visible');
        }
        function clearCache() {
            localStorage.removeItem('cs_user_v4_ultra');
            location.reload();
        }

        function showToast(msg, err = false) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.className = err ? 'error show' : 'success show';
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        function initStars() {
            const cvs = document.getElementById('star-canvas');
            const ctx = cvs.getContext('2d');
            let w = cvs.width = window.innerWidth;
            let h = cvs.height = window.innerHeight;
            const stars = Array(100).fill().map(() => ({
                x: Math.random() * w, y: Math.random() * h,
                size: Math.random() * 2, speed: Math.random() * 0.5 + 0.1,
                alpha: Math.random()
            }));
            
            function anim() {
                ctx.clearRect(0, 0, w, h);
                stars.forEach(s => {
                    s.y -= s.speed; 
                    if (s.y < 0) { s.y = h; s.x = Math.random() * w; }
                    ctx.beginPath(); 
                    ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2); 
                    ctx.fillStyle = `rgba(255, 255, 255, ${s.alpha})`;
                    ctx.fill();
                });
                requestAnimationFrame(anim);
            }
            anim();
        }
    </script>
</body>
</html>
