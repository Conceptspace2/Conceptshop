<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CONCEPT SPACE 4.0 INFINITY</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* =========================================
           GLOBAL VARIABLES & RESET
           ========================================= */
        :root {
            --bg-dark: #050505;
            --bg-card: #121212;
            --bg-nav: rgba(18, 18, 18, 0.95);
            
            --text-main: #ffffff;
            --text-muted: #888888;
            
            --accent: #00ff9d;      /* Neon Green */
            --accent-dim: #00b871;
            --accent-glow: rgba(0, 255, 157, 0.3);
            
            --secondary: #9d00ff;   /* Neon Purple */
            --secondary-glow: rgba(157, 0, 255, 0.3);
            
            --danger: #ff4757;
            --warning: #ffa502;
            
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.08);
            
            --radius-s: 8px;
            --radius-m: 16px;
            --radius-l: 24px;
            --radius-xl: 32px;
            
            --ease-bounce: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --ease-smooth: cubic-bezier(0.23, 1, 0.32, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden; /* App-like scroll handling */
            display: flex; flex-direction: column;
        }

        /* =========================================
           LOADER SCREEN
           ========================================= */
        .app-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
        .loader-spinner {
            width: 50px; height: 50px;
            border: 3px solid rgba(0,255,157,0.2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loader-text {
            margin-top: 20px; font-size: 14px; letter-spacing: 2px;
            background: linear-gradient(90deg, #fff, #666);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-weight: 800; animation: pulse 2s infinite;
        }

        /* =========================================
           LAYOUT STRUCTURE
           ========================================= */
        .app-header {
            padding: 15px 20px;
            background: rgba(5,5,5,0.8); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            z-index: 50; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .brand { font-size: 18px; font-weight: 900; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .brand i { color: var(--accent); filter: drop-shadow(0 0 8px var(--accent-glow)); }

        .app-content {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding-bottom: 90px; /* Space for Nav Bar */
            position: relative;
        }

        /* Views (Tabs) */
        .view-section { display: none; padding: 15px; animation: fadeIn 0.4s var(--ease-smooth); }
        .view-section.active { display: block; }

        /* =========================================
           COMPONENTS
           ========================================= */
        /* Search */
        .search-container { position: sticky; top: 0; z-index: 40; background: var(--bg-dark); padding: 5px 0 15px 0; }
        .search-bar {
            width: 100%; background: #161616; border: 1px solid var(--border);
            border-radius: var(--radius-m); padding: 12px 15px 12px 45px;
            color: #fff; font-size: 14px; outline: none; transition: 0.3s;
        }
        .search-bar:focus { border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); background: #1a1a1a; }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-65%); color: #555; }

        /* Categories */
        .cat-row {
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 15px;
            scrollbar-width: none;
        }
        .cat-row::-webkit-scrollbar { display: none; }
        .cat-btn {
            padding: 8px 18px; border-radius: 50px; background: #1a1a1a;
            border: 1px solid var(--border); color: #aaa; font-size: 12px; font-weight: 700;
            white-space: nowrap; transition: 0.3s; cursor: pointer;
        }
        .cat-btn.active {
            background: var(--accent); color: #000; border-color: var(--accent);
            box-shadow: 0 4px 12px var(--accent-glow); transform: translateY(-2px);
        }

        /* Product Grid */
        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .prod-card {
            background: var(--bg-card); border-radius: var(--radius-m);
            border: 1px solid var(--border); overflow: hidden;
            position: relative; display: flex; flex-direction: column;
            transition: 0.3s;
        }
        .prod-card:active { transform: scale(0.97); }

        .prod-img-wrap { width: 100%; padding-top: 100%; position: relative; background: #080808; }
        .prod-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        
        .stock-badge {
            position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.8);
            padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800;
            color: #fff; backdrop-filter: blur(4px); border: 1px solid #333; z-index: 2;
        }
        .stock-badge.out { color: var(--danger); border-color: rgba(255, 71, 87, 0.3); }

        .fav-btn-card {
            position: absolute; top: 8px; right: 8px; width: 30px; height: 30px;
            background: rgba(20,20,20,0.8); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #fff; backdrop-filter: blur(4px); z-index: 2; border: 1px solid var(--border);
            transition: 0.3s;
        }
        .fav-btn-card.active { color: var(--danger); background: rgba(255,255,255,0.9); transform: scale(1.1); }

        .prod-info { padding: 12px; flex: 1; display: flex; flex-direction: column; }
        .prod-title { font-size: 13px; font-weight: 600; line-height: 1.4; color: #eee; margin-bottom: 5px; flex: 1; }
        
        .prod-meta { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 8px; }
        .prod-price { font-size: 16px; font-weight: 800; color: var(--accent); }
        .prod-add {
            width: 32px; height: 32px; background: #222; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; color: var(--accent);
            border: 1px solid #333;
        }

        /* Bottom Nav */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 75px;
            background: var(--bg-nav); backdrop-filter: blur(20px);
            border-top: 1px solid var(--border); z-index: 100;
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: 15px; /* iOS safe area */
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 4px; color: #666; font-size: 10px; font-weight: 600; height: 100%;
            transition: 0.2s; cursor: pointer; position: relative;
        }
        .nav-item i { font-size: 20px; transition: 0.2s; }
        .nav-item.active { color: var(--accent); }
        .nav-item.active i { transform: translateY(-2px); text-shadow: 0 4px 12px var(--accent-glow); }
        
        .nav-badge {
            position: absolute; top: 10px; right: 25px;
            background: var(--danger); color: #fff; font-size: 10px;
            min-width: 16px; height: 16px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; border: 2px solid var(--bg-nav);
            transform: scale(0); transition: 0.3s var(--ease-bounce);
        }
        .nav-badge.visible { transform: scale(1); }

        /* =========================================
           SHEETS & MODALS
           ========================================= */
        .modal-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            z-index: 200; opacity: 0; pointer-events: none; transition: 0.4s;
        }
        .modal-layer.visible { opacity: 1; pointer-events: all; }

        .sheet {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #111; border-radius: var(--radius-l) var(--radius-l) 0 0;
            padding: 24px; z-index: 201; border-top: 1px solid #222;
            transform: translateY(110%); transition: transform 0.5s var(--ease-smooth);
            max-height: 90vh; display: flex; flex-direction: column;
        }
        .sheet.active { transform: translateY(0); }

        /* Detail View Styles */
        .detail-header { display: flex; gap: 20px; margin-bottom: 25px; }
        .detail-img { width: 100px; height: 100px; border-radius: var(--radius-m); object-fit: cover; background: #222; border: 1px solid #333; }
        
        .chip-group { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; }
        .chip {
            padding: 10px 16px; background: #1a1a1a; border-radius: 12px;
            border: 1px solid #333; color: #888; font-size: 13px; font-weight: 600;
            transition: 0.2s; cursor: pointer;
        }
        .chip.selected { background: rgba(0,255,157,0.1); border-color: var(--accent); color: var(--accent); }

        /* Cart Styles */
        .cart-list { flex: 1; overflow-y: auto; margin: 15px 0; padding-right: 5px; }
        .cart-row {
            display: flex; align-items: center; gap: 12px; background: #161616;
            padding: 12px; border-radius: 14px; margin-bottom: 10px; border: 1px solid #222;
        }
        
        /* Promo Input */
        .promo-box { display: flex; gap: 10px; margin-top: 10px; margin-bottom: 20px; }
        .promo-inp {
            flex: 1; background: #0a0a0a; border: 1px dashed #444; padding: 12px;
            border-radius: 12px; color: #fff; outline: none; text-transform: uppercase;
            font-weight: 700; letter-spacing: 1px;
        }
        .promo-btn {
            background: #222; border: 1px solid #333; color: #fff;
            padding: 0 15px; border-radius: 12px; font-weight: 600; font-size: 12px;
        }

        /* Buttons */
        .btn {
            width: 100%; padding: 16px; border-radius: 16px; border: none;
            font-size: 16px; font-weight: 800; letter-spacing: 0.5px;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            cursor: pointer; transition: 0.2s; text-transform: uppercase;
        }
        .btn-primary {
            background: var(--accent); color: #000;
            box-shadow: 0 5px 20px var(--accent-glow);
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-disabled { background: #333; color: #666; pointer-events: none; box-shadow: none; }

        .qty-controls { display: flex; align-items: center; gap: 15px; background: #222; padding: 5px; border-radius: 12px; }
        .qty-btn { width: 30px; height: 30px; border: none; background: #333; color: #fff; border-radius: 8px; font-weight: bold; }

        /* =========================================
           ADMIN PANEL
           ========================================= */
        .admin-panel {
            position: fixed; inset: 0; background: #000; z-index: 300;
            transform: translateX(100%); transition: 0.4s var(--ease-smooth);
            display: flex; flex-direction: column;
        }
        .admin-panel.open { transform: translateX(0); }
        
        .admin-content { padding: 20px; overflow-y: auto; flex: 1; }
        .admin-tabs { display: flex; border-bottom: 1px solid #222; margin-bottom: 20px; }
        .adm-tab { flex: 1; padding: 15px; text-align: center; color: #666; font-weight: 700; font-size: 12px; border-bottom: 2px solid transparent; }
        .adm-tab.active { color: #fff; border-color: var(--accent); }

        .form-group { margin-bottom: 15px; }
        .form-label { font-size: 11px; color: #666; margin-bottom: 6px; text-transform: uppercase; font-weight: 700; }
        .form-inp {
            width: 100%; padding: 14px; background: #161616; border: 1px solid #333;
            color: #fff; border-radius: 10px; outline: none; font-size: 14px;
        }
        .form-inp:focus { border-color: var(--accent); }
        
        .dash-card {
            background: linear-gradient(135deg, #1a1a1a, #111);
            padding: 20px; border-radius: 18px; border: 1px solid #222;
            margin-bottom: 15px; display: flex; align-items: center; gap: 15px;
        }
        .dash-icon { width: 50px; height: 50px; background: rgba(0,255,157,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--accent); font-size: 20px; }

        /* Floating Admin Button */
        .admin-trigger {
            position: fixed; bottom: 100px; right: 20px; width: 44px; height: 44px;
            background: rgba(30,30,30,0.8); backdrop-filter: blur(5px);
            border-radius: 50%; color: #555; display: flex; align-items: center; justify-content: center;
            border: 1px solid #333; box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 90;
        }

        /* Toast */
        .toast-container { position: fixed; top: 20px; left: 0; width: 100%; display: flex; justify-content: center; pointer-events: none; z-index: 1000; }
        .toast {
            background: rgba(20,20,20,0.95); backdrop-filter: blur(10px);
            border: 1px solid #333; padding: 12px 24px; border-radius: 50px;
            color: #fff; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 10px;
            transform: translateY(-100px); transition: 0.5s var(--ease-bounce); opacity: 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .toast.visible { transform: translateY(0); opacity: 1; }
        .toast.success { border-color: var(--accent); }
        .toast.error { border-color: var(--danger); }

        /* Animations */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .skeleton { background: #1a1a1a; animation: pulse 1.5s infinite; }
    </style>
</head>
<body>

    <div class="app-loader" id="loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">CONCEPT SPACE</div>
        <div style="margin-top:5px; font-size:10px; color:#444;">V 4.0 INFINITY</div>
    </div>

    <header class="app-header">
        <div class="brand">
            <i class="fas fa-meteor"></i> CS 4.0
        </div>
        <div style="font-size: 12px; font-weight: 700; color: #666;">
            <i class="fas fa-signal" style="margin-right:5px; color:var(--accent)"></i> ONLINE
        </div>
    </header>

    <div class="app-content" id="appContent">
        
        <section id="view-home" class="view-section active">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-bar" id="searchInp" placeholder="–ü–æ–∏—Å–∫ (–Ω–∞–ø—Ä. Geekvape)...">
            </div>

            <div class="cat-row" id="catList">
                <button class="cat-btn active" onclick="filterCat('all', this)">–í—Å–µ</button>
                <button class="cat-btn" onclick="filterCat('pod', this)">Pods</button>
                <button class="cat-btn" onclick="filterCat('vape', this)">Vapes</button>
                <button class="cat-btn" onclick="filterCat('liquid', this)">–ñ–∏–∂–∏</button>
                <button class="cat-btn" onclick="filterCat('parts', this)">Cartridge</button>
            </div>

            <div class="grid-layout" id="grid">
                </div>
            
            <div style="height: 40px;"></div> </section>

        <section id="view-fav" class="view-section">
            <h2 style="margin-bottom:20px; font-size:24px;">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ <span style="color:var(--danger)">‚ù§</span></h2>
            <div class="grid-layout" id="favGrid">
                <div style="grid-column: 1/-1; text-align: center; color: #555; padding: 50px;">
                    –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
                </div>
            </div>
        </section>

        <section id="view-profile" class="view-section">
            <div style="text-align:center; margin-bottom:30px;">
                <div style="width:80px; height:80px; background:#222; border-radius:50%; margin:0 auto 15px auto; display:flex; align-items:center; justify-content:center; border:2px solid var(--accent);">
                    <i class="fas fa-user-astronaut" style="font-size:40px; color:#fff;"></i>
                </div>
                <h2 style="font-size:20px;" id="userName">User</h2>
                <div style="color:var(--accent); font-size:12px; font-weight:700;">PRO MEMBER</div>
            </div>

            <div class="dash-card" style="margin-bottom:10px;">
                <div class="dash-icon" style="color:#fff; background:rgba(255,255,255,0.1)"><i class="fas fa-history"></i></div>
                <div>
                    <div style="font-size:14px; font-weight:700;">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</div>
                    <div style="font-size:11px; color:#666;">–õ–æ–∫–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è</div>
                </div>
            </div>
             <div class="dash-card">
                <div class="dash-icon" style="color:var(--secondary); background:rgba(157,0,255,0.1)"><i class="fas fa-gift"></i></div>
                <div>
                    <div style="font-size:14px; font-weight:700;">–ú–æ–∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã</div>
                    <div style="font-size:11px; color:#666;">START, VIP2024</div>
                </div>
            </div>
        </section>

    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchView('home', this)">
            <i class="fas fa-home"></i>
            <span>–ì–ª–∞–≤–Ω–∞—è</span>
        </div>
        <div class="nav-item" onclick="switchView('fav', this)">
            <i class="fas fa-heart"></i>
            <span>–í–∏–º–æ</span>
        </div>
        <div class="nav-item" onclick="openCart()">
            <div class="nav-badge" id="cartBadge">0</div>
            <i class="fas fa-shopping-bag"></i>
            <span>–ö–æ—Ä–∑–∏–Ω–∞</span>
        </div>
        <div class="nav-item" onclick="switchView('profile', this)">
            <i class="fas fa-user"></i>
            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
    </nav>

    <div class="modal-layer" id="modalLayer"></div>

    <div class="sheet" id="prodSheet">
        <div class="detail-header">
            <img id="sImg" class="detail-img">
            <div style="flex:1">
                <div id="sStatus" style="font-size:10px; font-weight:800; margin-bottom:5px; color:#666;">IN STOCK</div>
                <h2 id="sTitle" style="font-size:18px; line-height:1.2; margin-bottom:8px;">Product</h2>
                <div id="sDesc" style="font-size:12px; color:#888; max-height:60px; overflow-y:auto; line-height:1.4;"></div>
            </div>
        </div>

        <div style="font-size:11px; font-weight:700; color:#666; text-transform:uppercase;">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∫—É—Å / –æ–ø—Ü–∏—é</div>
        <div class="chip-group" id="sFlavors"></div>

        <div style="margin-top:auto; display:flex; gap:15px; align-items:center;">
            <div class="qty-controls">
                <button class="qty-btn" onclick="updSheetQty(-1)">-</button>
                <span id="sQty" style="font-weight:bold; width:20px; text-align:center;">1</span>
                <button class="qty-btn" onclick="updSheetQty(1)">+</button>
            </div>
            <button class="btn btn-primary" id="sAddBtn" onclick="addToCartCurrent()">
                <span>–í –∫–æ—Ä–∑–∏–Ω—É</span> <span style="opacity:0.5">|</span> <span id="sPrice">0 ‚Ç¨</span>
            </button>
        </div>
    </div>

    <div class="sheet" id="cartSheet" style="height:80vh;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="font-size:22px;">–ö–æ—Ä–∑–∏–Ω–∞</h2>
            <div onclick="clearCart()" style="color:var(--danger); font-size:12px; font-weight:700; cursor:pointer;">
                <i class="fas fa-trash"></i> –û–ß–ò–°–¢–ò–¢–¨
            </div>
        </div>
        
        <div class="cart-list" id="cartList"></div>
        
        <div class="promo-box">
            <input type="text" class="promo-inp" id="promoInput" placeholder="–ï—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥?">
            <button class="promo-btn" onclick="applyPromo()">OK</button>
        </div>

        <div style="border-top:1px solid #222; padding-top:15px; margin-top:auto;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:14px; color:#888;">
                <span>–ü–æ–¥—ã—Ç–æ–≥:</span> <span id="cartSubtotal">0 ‚Ç¨</span>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:14px; color:var(--accent);">
                <span>–°–∫–∏–¥–∫–∞:</span> <span id="cartDiscount">0 ‚Ç¨</span>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-size:20px; font-weight:800; color:#fff;">
                <span>–ò—Ç–æ–≥–æ:</span> <span id="cartFinal">0 ‚Ç¨</span>
            </div>
            <button class="btn btn-primary" onclick="checkout()">
                –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
            </button>
        </div>
    </div>

    <div class="admin-trigger" onclick="openAdminAuth()"><i class="fas fa-fingerprint"></i></div>
    
    <div class="admin-panel" id="adminPanel">
        <div style="padding:20px; border-bottom:1px solid #222; display:flex; justify-content:space-between; align-items:center;">
            <h2 style="color:var(--accent);">ADMIN CONSOLE</h2>
            <button onclick="toggleAdmin(false)" style="background:none; border:none; color:#fff; font-size:24px;">&times;</button>
        </div>
        
        <div class="admin-tabs">
            <div class="adm-tab active" onclick="switchAdminTab('add')">–†–ï–î–ê–ö–¢–û–†</div>
            <div class="adm-tab" onclick="switchAdminTab('dash')">–î–ê–®–ë–û–†–î</div>
        </div>

        <div class="admin-content">
            <div id="adm-add">
                <div class="dash-card">
                    <div style="flex:1">
                        <div id="formTitle" style="font-weight:bold; color:#fff;">–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</div>
                        <div style="font-size:11px; color:#666;" onclick="cancelEdit()" id="cancelBtn">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã</div>
                    </div>
                    <button onclick="saveProduct()" class="btn btn-primary" style="width:auto; padding:10px 20px; font-size:12px;">SAVE</button>
                </div>

                <div class="form-group">
                    <div class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                    <input id="inpName" class="form-inp" placeholder="Geekvape Aegis...">
                </div>
                
                <div style="display:flex; gap:10px;">
                    <div class="form-group" style="flex:1">
                        <div class="form-label">–¶–µ–Ω–∞ (‚Ç¨)</div>
                        <input id="inpPrice" type="number" class="form-inp" placeholder="0.00">
                    </div>
                    <div class="form-group" style="flex:1">
                        <div class="form-label">–°—Ç–æ–∫ (—à—Ç)</div>
                        <input id="inpStock" type="number" class="form-inp" placeholder="99">
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
                    <select id="inpCat" class="form-inp">
                        <option value="pod">Pod Systems</option>
                        <option value="vape">Disposable Vapes</option>
                        <option value="liquid">E-Liquids</option>
                        <option value="parts">Parts/Cartridges</option>
                    </select>
                </div>

                <div class="form-group">
                    <div class="form-label">–í–∫—É—Å—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</div>
                    <input id="inpFlavors" class="form-inp" placeholder="Mint, Mango, Cola">
                </div>

                <div class="form-group">
                    <div class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ</div>
                    <input id="inpImg" class="form-inp" placeholder="https://..." oninput="previewAdmin(this.value)">
                    <img id="adminPrev" style="width:60px; height:60px; border-radius:8px; margin-top:10px; display:none; object-fit:cover; border:1px solid #333;">
                </div>

                <hr style="border:0; border-top:1px solid #222; margin:20px 0;">
                <div id="adminList"></div>
            </div>

            <div id="adm-dash" style="display:none;">
                <div class="dash-card">
                    <div class="dash-icon"><i class="fas fa-box"></i></div>
                    <div>
                        <div style="font-size:24px; font-weight:bold;" id="statCount">0</div>
                        <div style="font-size:12px; color:#666;">–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤</div>
                    </div>
                </div>
                <div class="dash-card">
                    <div class="dash-icon" style="color:var(--warning); background:rgba(255,165,2,0.1)"><i class="fas fa-coins"></i></div>
                    <div>
                        <div style="font-size:24px; font-weight:bold;" id="statVal">0 ‚Ç¨</div>
                        <div style="font-size:12px; color:#666;">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å—Ç–æ–∫–∞</div>
                    </div>
                </div>
                <button class="btn btn-primary" style="background:#222; border:1px solid #333; color:#fff;" onclick="forceSync()">
                    <i class="fas fa-sync"></i> –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø
                </button>
            </div>
        </div>
    </div>

    <div id="authModal" style="position:fixed; inset:0; background:#000; z-index:999; display:none; flex-direction:column; align-items:center; justify-content:center;">
        <i class="fas fa-shield-alt" style="font-size:50px; color:var(--accent); margin-bottom:20px;"></i>
        <h2 style="margin-bottom:20px;">SECURITY CHECK</h2>
        <input type="password" id="passInp" class="form-inp" style="width:200px; text-align:center; font-size:20px; letter-spacing:5px;" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn" style="width:auto; padding:10px 20px; background:#222; color:#fff;" onclick="document.getElementById('authModal').style.display='none'">EXIT</button>
            <button class="btn btn-primary" style="width:auto; padding:10px 20px;" onclick="checkPass()">ENTER</button>
        </div>
    </div>

    <div class="toast-container">
        <div class="toast" id="toastBox">
            <i class="fas fa-info-circle"></i>
            <span id="toastMsg">Notification</span>
        </div>
    </div>

    <script>
        // ================= CONFIGURATION =================
        const CFG = {
            BIN_ID: "696e703dae596e708fe71325", // Your JSONBin ID
            API_KEY: "$2a$10$KhVEyfwrswNvk7dNQEJWPezsQABoaOnmNm/jtb8vqYWBJrL8eciFm", // Your API Key
            TG_USER: "username", // Telegram Username (no @)
            ADMIN_PIN: "1234"
        };
        // ===============================================

        // GLOBAL STATE
        let DB = [];
        let CART = [];
        let FAVS = [];
        let ACTIVE_CAT = 'all';
        let PROMO = { code: '', discount: 0 };
        
        let curProd = null;
        let sheetQty = 1;
        let sheetFlavor = '';
        let editId = null;

        const tg = window.Telegram.WebApp;

        // --- INIT ---
        window.onload = async () => {
            tg.ready(); tg.expand();
            
            // Set User Name if avail
            if(tg.initDataUnsafe && tg.initDataUnsafe.user) {
                document.getElementById('userName').innerText = tg.initDataUnsafe.user.first_name;
            }

            // Simulate Heavy Loading
            setTimeout(async () => {
                await loadData();
                loadLocal();
                renderGrid();
                updateStats();
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
            }, 1500);
        };

        // --- NAVIGATION LOGIC ---
        function switchView(viewName, btnEl) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(btnEl) btnEl.classList.add('active');
            
            // Refresh grids if needed
            if(viewName === 'fav') renderFavs();
            
            window.scrollTo({top:0, behavior:'smooth'});
            tg.HapticFeedback.selectionChanged();
        }

        // --- DATA LAYER ---
        async function loadData() {
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': CFG.API_KEY }
                });
                const data = await res.json();
                DB = Array.isArray(data.record) ? data.record : [];
            } catch(e) {
                showToast("Offline Mode (Cache)", true);
            }
        }

        async function saveData() {
            try {
                await fetch(`https://api.jsonbin.io/v3/b/${CFG.BIN_ID}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': CFG.API_KEY },
                    body: JSON.stringify(DB)
                });
                showToast("–ë–∞–∑–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
            } catch(e) {
                showToast("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", true);
            }
        }

        function loadLocal() {
            const c = localStorage.getItem('cs_cart_v4');
            if(c) CART = JSON.parse(c);
            const f = localStorage.getItem('cs_favs_v4');
            if(f) FAVS = JSON.parse(f);
            updateCartBadge();
        }

        function saveLocal() {
            localStorage.setItem('cs_cart_v4', JSON.stringify(CART));
            localStorage.setItem('cs_favs_v4', JSON.stringify(FAVS));
            updateCartBadge();
        }

        // --- RENDERERS ---
        function renderGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            const list = ACTIVE_CAT === 'all' ? DB : DB.filter(x => x.cat === ACTIVE_CAT);
            
            if(list.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#444">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ...</div>';
                return;
            }

            list.forEach(p => {
                const isFav = FAVS.includes(p.id);
                const inStock = (p.stock > 0);
                
                const card = document.createElement('div');
                card.className = 'prod-card';
                card.innerHTML = `
                    <div class="prod-img-wrap" onclick="openProd(${p.id})">
                        <img src="${p.img || ''}" class="prod-img" loading="lazy">
                        ${!inStock ? '<div class="stock-badge out">SOLD OUT</div>' : ''}
                        ${p.stock < 5 && inStock ? `<div class="stock-badge" style="color:orange; border-color:orange">LOW: ${p.stock}</div>` : ''}
                        <div class="fav-btn-card ${isFav?'active':''}" onclick="event.stopPropagation(); toggleFav(${p.id})">
                            <i class="fas fa-heart"></i>
                        </div>
                    </div>
                    <div class="prod-info" onclick="openProd(${p.id})">
                        <div class="prod-title">${p.name}</div>
                        <div class="prod-meta">
                            <div class="prod-price">${p.price} ‚Ç¨</div>
                            <div class="prod-add"><i class="fas fa-plus"></i></div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function renderFavs() {
            const grid = document.getElementById('favGrid');
            grid.innerHTML = '';
            const list = DB.filter(p => FAVS.includes(p.id));
            
            if(list.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#444">–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</div>';
                return;
            }
            
            // Simple render for favs (reusing logic could be better but keeping it verbose for request)
            list.forEach(p => {
                grid.innerHTML += `
                    <div class="prod-card" onclick="openProd(${p.id})">
                        <div class="prod-img-wrap">
                            <img src="${p.img}" class="prod-img">
                             <div class="fav-btn-card active" onclick="event.stopPropagation(); toggleFav(${p.id})"><i class="fas fa-heart"></i></div>
                        </div>
                        <div class="prod-info">
                            <div class="prod-title">${p.name}</div>
                            <div class="prod-price">${p.price} ‚Ç¨</div>
                        </div>
                    </div>
                `;
            });
        }

        function filterCat(cat, btn) {
            ACTIVE_CAT = cat;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            renderGrid();
            tg.HapticFeedback.selectionChanged();
        }

        // --- PRODUCT LOGIC ---
        function openProd(id) {
            curProd = DB.find(x => x.id === id);
            if(!curProd) return;
            
            sheetQty = 1;
            document.getElementById('sQty').innerText = "1";
            document.getElementById('sTitle').innerText = curProd.name;
            document.getElementById('sDesc').innerText = "–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞: " + (curProd.name) + ". –õ—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ –Ω–∞ —Ä—ã–Ω–∫–µ.";
            document.getElementById('sImg').src = curProd.img || '';
            document.getElementById('sPrice').innerText = curProd.price + " ‚Ç¨";
            
            // Stock Logic
            const btn = document.getElementById('sAddBtn');
            const status = document.getElementById('sStatus');
            
            if(curProd.stock > 0) {
                btn.classList.remove('btn-disabled');
                btn.innerHTML = `<span>–í –ö–û–†–ó–ò–ù–£</span> <span style="opacity:0.5">|</span> <span id="sPrice">${curProd.price} ‚Ç¨</span>`;
                status.innerText = `–í –ù–ê–õ–ò–ß–ò–ò: ${curProd.stock} —à—Ç.`;
                status.style.color = "var(--accent)";
            } else {
                btn.classList.add('btn-disabled');
                btn.innerHTML = "–ù–ï–¢ –í –ù–ê–õ–ò–ß–ò–ò";
                status.innerText = "SOLD OUT";
                status.style.color = "var(--danger)";
            }

            // Flavors
            const fBox = document.getElementById('sFlavors');
            fBox.innerHTML = '';
            const flavors = curProd.flavors && curProd.flavors.length ? curProd.flavors : ['Default'];
            sheetFlavor = flavors[0];
            
            flavors.forEach(f => {
                const c = document.createElement('div');
                c.className = `chip ${f===sheetFlavor?'selected':''}`;
                c.innerText = f;
                c.onclick = () => {
                    sheetFlavor = f;
                    document.querySelectorAll('.chip').forEach(el => el.classList.remove('selected'));
                    c.classList.add('selected');
                };
                fBox.appendChild(c);
            });

            openSheet('prodSheet');
        }

        function updSheetQty(d) {
            if(sheetQty + d < 1) return;
            // Check stock cap
            if(curProd && sheetQty + d > curProd.stock) {
                showToast(`–í—Å–µ–≥–æ ${curProd.stock} —à—Ç –≤ –Ω–∞–ª–∏—á–∏–∏`, true);
                return;
            }
            sheetQty += d;
            document.getElementById('sQty').innerText = sheetQty;
            document.getElementById('sPrice').innerText = (curProd.price * sheetQty).toFixed(2) + " ‚Ç¨";
        }

        function addToCartCurrent() {
            if(!curProd) return;
            addToCart(curProd.id, sheetFlavor, sheetQty);
            closeSheet();
        }

        function toggleFav(id) {
            if(FAVS.includes(id)) {
                FAVS = FAVS.filter(x => x !== id);
                showToast("–£–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ");
            } else {
                FAVS.push(id);
                showToast("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ");
                tg.HapticFeedback.notificationOccurred('success');
            }
            saveLocal();
            renderGrid(); // Re-render to update hearts
            if(document.getElementById('view-fav').classList.contains('active')) renderFavs();
        }

        // --- CART LOGIC ---
        function addToCart(id, fl, qty) {
            const prod = DB.find(x => x.id === id);
            if(!prod) return;
            
            const ex = CART.find(x => x.id === id && x.fl === fl);
            if(ex) {
                if(ex.q + qty > prod.stock) {
                    showToast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ", true);
                    return;
                }
                ex.q += qty;
            } else {
                 CART.push({
                     id: prod.id, name: prod.name, price: prod.price, img: prod.img, fl: fl, q: qty
                 });
            }
            saveLocal();
            showToast("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É");
        }

        function openCart() {
            renderCartList();
            openSheet('cartSheet');
        }

        function renderCartList() {
            const list = document.getElementById('cartList');
            list.innerHTML = '';
            
            if(CART.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:30px; color:#555">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>';
                updateCartTotals();
                return;
            }

            CART.forEach((item, idx) => {
                list.innerHTML += `
                    <div class="cart-row">
                        <img src="${item.img}" style="width:50px; height:50px; border-radius:8px; object-fit:cover;">
                        <div style="flex:1">
                            <div style="font-weight:700; font-size:13px;">${item.name}</div>
                            <div style="font-size:11px; color:#888;">${item.fl}</div>
                            <div style="color:var(--accent);">${(item.price*item.q).toFixed(2)} ‚Ç¨</div>
                        </div>
                        <div style="display:flex; gap:10px; align-items:center;">
                             <div onclick="modCart(${idx}, -1)" style="padding:5px 10px; background:#222; border-radius:6px;">-</div>
                             <div style="font-weight:bold;">${item.q}</div>
                             <div onclick="modCart(${idx}, 1)" style="padding:5px 10px; background:#222; border-radius:6px;">+</div>
                        </div>
                    </div>
                `;
            });
            updateCartTotals();
        }

        function modCart(idx, d) {
            const item = CART[idx];
            // Check stock logic if increasing
            if(d > 0) {
                const p = DB.find(x => x.id === item.id);
                if(p && item.q + 1 > p.stock) {
                    showToast("–ú–∞–∫—Å–∏–º—É–º –Ω–∞ —Å–∫–ª–∞–¥–µ", true);
                    return;
                }
            }
            
            item.q += d;
            if(item.q <= 0) CART.splice(idx, 1);
            saveLocal();
            renderCartList();
        }

        function applyPromo() {
            const code = document.getElementById('promoInput').value.toUpperCase();
            if(code === 'START' || code === 'VIP2024') {
                PROMO = { code: code, discount: 0.1 }; // 10%
                showToast(`–ü—Ä–æ–º–æ–∫–æ–¥ ${code} –ø—Ä–∏–Ω—è—Ç! -10%`);
                updateCartTotals();
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                PROMO = { code: '', discount: 0 };
                showToast("–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥", true);
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        function updateCartTotals() {
            let sub = CART.reduce((a, b) => a + (b.price * b.q), 0);
            let disc = sub * PROMO.discount;
            let final = sub - disc;
            
            document.getElementById('cartSubtotal').innerText = sub.toFixed(2) + ' ‚Ç¨';
            document.getElementById('cartDiscount').innerText = "-" + disc.toFixed(2) + ' ‚Ç¨';
            document.getElementById('cartFinal').innerText = final.toFixed(2) + ' ‚Ç¨';
        }

        function checkout() {
            if(CART.length === 0) return;
            
            let msg = `üöÄ *–ó–ê–ö–ê–ó CONCEPT SPACE*\n`;
            msg += `üë§ ${document.getElementById('userName').innerText}\n`;
            msg += `---------------------------\n`;
            CART.forEach(x => {
                msg += `‚ñ™ ${x.name} (${x.fl}) x${x.q} = ${(x.price*x.q).toFixed(2)}\n`;
            });
            msg += `---------------------------\n`;
            if(PROMO.code) msg += `üéÅ PROMO: ${PROMO.code} (-${(PROMO.discount*100)}%)\n`;
            msg += `üí∞ *–ò–¢–û–ì–û: ${document.getElementById('cartFinal').innerText}*`;

            tg.close();
            setTimeout(() => {
                window.open(`https://t.me/${CFG.TG_USER}?text=${encodeURIComponent(msg)}`);
            }, 100);
            
            // Clear cart logic optional
            // CART = []; saveLocal();
        }
        
        function clearCart() {
            if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?")) {
                CART = [];
                PROMO = {code:'', discount:0};
                saveLocal();
                renderCartList();
            }
        }

        function updateCartBadge() {
            const count = CART.reduce((a,b)=>a+b.q,0);
            const b = document.getElementById('cartBadge');
            b.innerText = count;
            if(count > 0) b.classList.add('visible');
            else b.classList.remove('visible');
        }

        // --- ADMIN & EDITING ---
        function openAdminAuth() { document.getElementById('authModal').style.display='flex'; }
        
        function checkPass() {
            if(document.getElementById('passInp').value === CFG.ADMIN_PIN) {
                document.getElementById('authModal').style.display='none';
                toggleAdmin(true);
                renderAdminList();
                updateStats();
            } else {
                showToast("ACCESS DENIED", true);
            }
        }

        function toggleAdmin(st) {
            const p = document.getElementById('adminPanel');
            if(st) p.classList.add('open');
            else p.classList.remove('open');
        }
        
        function switchAdminTab(t) {
            document.querySelectorAll('.adm-tab').forEach(x => x.classList.remove('active'));
            document.querySelector(`.adm-tab[onclick*='${t}']`).classList.add('active');
            
            document.getElementById('adm-add').style.display = t==='add'?'block':'none';
            document.getElementById('adm-dash').style.display = t==='dash'?'block':'none';
        }

        function renderAdminList() {
            const l = document.getElementById('adminList');
            l.innerHTML = '';
            DB.forEach(p => {
                l.innerHTML += `
                    <div style="display:flex; gap:10px; align-items:center; background:#161616; padding:8px; margin-bottom:8px; border-radius:8px; border:1px solid #333;">
                        <img src="${p.img}" style="width:30px; height:30px; border-radius:4px; object-fit:cover;">
                        <div style="flex:1; font-size:12px;" onclick="editProd(${p.id})">${p.name} <span style="color:#666">(${p.stock})</span></div>
                        <i class="fas fa-trash" style="color:var(--danger); padding:8px;" onclick="delProd(${p.id})"></i>
                    </div>
                `;
            });
        }
        
        function updateStats() {
            document.getElementById('statCount').innerText = DB.length;
            const val = DB.reduce((a,b) => a + (b.price * b.stock), 0);
            document.getElementById('statVal').innerText = val.toFixed(0) + " ‚Ç¨";
        }

        function editProd(id) {
            const p = DB.find(x => x.id === id);
            editId = id;
            document.getElementById('formTitle').innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: " + p.name;
            document.getElementById('cancelBtn').style.display = 'block';
            
            document.getElementById('inpName').value = p.name;
            document.getElementById('inpPrice').value = p.price;
            document.getElementById('inpStock').value = p.stock || 0;
            document.getElementById('inpCat').value = p.cat;
            document.getElementById('inpFlavors').value = p.flavors.join(', ');
            document.getElementById('inpImg').value = p.img;
            previewAdmin(p.img);
        }

        function cancelEdit() {
            editId = null;
            document.getElementById('formTitle').innerText = "–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä";
            document.getElementById('cancelBtn').style.display = 'none';
            document.querySelectorAll('.form-inp').forEach(x => x.value = '');
            document.getElementById('adminPrev').style.display = 'none';
        }

        async function saveProduct() {
            const name = document.getElementById('inpName').value;
            const price = parseFloat(document.getElementById('inpPrice').value);
            const stock = parseInt(document.getElementById('inpStock').value);
            const cat = document.getElementById('inpCat').value;
            const fl = document.getElementById('inpFlavors').value.split(',').map(x=>x.trim());
            const img = document.getElementById('inpImg').value;

            if(!name || !price) return showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è", true);

            const obj = { id: editId || Date.now(), name, price, stock, cat, flavors: fl, img };
            
            if(editId) {
                const idx = DB.findIndex(x => x.id === editId);
                DB[idx] = obj;
            } else {
                DB.unshift(obj);
            }

            await saveData();
            renderAdminList();
            renderGrid();
            cancelEdit();
        }
        
        async function delProd(id) {
            if(confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) {
                DB = DB.filter(x => x.id !== id);
                await saveData();
                renderAdminList();
                renderGrid();
            }
        }
        
        function previewAdmin(u) {
            const i = document.getElementById('adminPrev');
            if(u){ i.src=u; i.style.display='block'; } else i.style.display='none';
        }

        // --- UTILS ---
        function openSheet(id) {
            document.getElementById('modalLayer').classList.add('visible');
            document.getElementById(id).classList.add('active');
        }
        function closeSheet() {
            document.getElementById('modalLayer').classList.remove('visible');
            document.querySelectorAll('.sheet').forEach(x => x.classList.remove('active'));
        }
        document.getElementById('modalLayer').onclick = closeSheet;

        function showToast(msg, err=false) {
            const t = document.getElementById('toastBox');
            const m = document.getElementById('toastMsg');
            t.className = err ? 'toast visible error' : 'toast visible success';
            m.innerText = msg;
            
            // Icon
            const icon = t.querySelector('i');
            icon.className = err ? 'fas fa-exclamation-triangle' : 'fas fa-check-circle';
            
            setTimeout(() => { t.classList.remove('visible'); }, 3000);
        }

    </script>
</body>
</html>
